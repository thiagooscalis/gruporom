# Generated by Django 5.2.4 on 2025-08-09 17:01

import django.db.models.deletion
from django.db import migrations, models


def clear_pais_data(apps, schema_editor):
    """
    Limpa os dados de país existentes (texto) antes da conversão para ForeignKey.
    """
    from django.db import connection
    
    # Primeiro, salvamos os dados existentes em uma tabela temporária
    with connection.cursor() as cursor:
        # Cria tabela temporária para backup dos dados
        cursor.execute("""
            CREATE TEMPORARY TABLE temp_pessoa_pais AS 
            SELECT id, pais FROM core_pessoa WHERE pais IS NOT NULL AND pais != ''
        """)
        
        # Limpa os dados de país para permitir a conversão
        cursor.execute("UPDATE core_pessoa SET pais = NULL")


def restore_pais_data(apps, schema_editor):
    """
    Tenta restaurar os dados de país convertendo texto para ForeignKey.
    """
    from django.db import connection
    Pessoa = apps.get_model('core', 'Pessoa')
    Pais = apps.get_model('core', 'Pais')
    
    with connection.cursor() as cursor:
        # Verifica se a tabela temporária existe
        cursor.execute("""
            SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE table_name = 'temp_pessoa_pais'
            )
        """)
        if cursor.fetchone()[0]:
            # Recupera os dados salvos
            cursor.execute("SELECT id, pais FROM temp_pessoa_pais")
            for pessoa_id, pais_nome in cursor.fetchall():
                try:
                    # Tenta encontrar o país pelo nome
                    pais_obj = Pais.objects.filter(nome__icontains=pais_nome).first()
                    if pais_obj:
                        Pessoa.objects.filter(id=pessoa_id).update(pais=pais_obj)
                except:
                    pass  # Ignora erros, deixa como null


def reverse_clear_pais_data(apps, schema_editor):
    """
    Reverse da limpeza dos dados.
    """
    pass


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0025_restructure_contacts"),
    ]

    operations = [
        # Primeiro limpa os dados de país
        migrations.RunPython(
            clear_pais_data,
            reverse_clear_pais_data,
        ),
        # Depois altera o campo
        migrations.AlterField(
            model_name="pessoa",
            name="pais",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                to="core.pais",
                verbose_name="País",
            ),
        ),
        # Por último tenta restaurar os dados convertidos
        migrations.RunPython(
            restore_pais_data,
            reverse_clear_pais_data,
        ),
    ]