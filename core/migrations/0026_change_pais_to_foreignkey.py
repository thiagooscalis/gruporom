# Generated by Django 5.2.4 on 2025-08-09 17:01

import django.db.models.deletion
from django.db import migrations, models


def convert_pais_field_manually(apps, schema_editor):
    """
    Converte o campo pais manualmente via SQL puro.
    """
    from django.db import connection
    
    with connection.cursor() as cursor:
        # 1. Remove dados existentes
        cursor.execute("UPDATE core_pessoa SET pais = NULL")
        
        # 2. Remove o campo antigo
        cursor.execute("ALTER TABLE core_pessoa DROP COLUMN pais")
        
        # 3. Adiciona novo campo como integer
        cursor.execute("ALTER TABLE core_pessoa ADD COLUMN pais INTEGER")
        
        # 4. Adiciona constraint de foreign key
        cursor.execute("""
            ALTER TABLE core_pessoa 
            ADD CONSTRAINT core_pessoa_pais_id_fkey 
            FOREIGN KEY (pais) REFERENCES core_pais(id) 
            ON DELETE SET NULL
        """)


def reverse_convert_pais_field(apps, schema_editor):
    """
    Reverse - converte de volta para CharField.
    """
    from django.db import connection
    
    with connection.cursor() as cursor:
        # Remove foreign key constraint
        cursor.execute("ALTER TABLE core_pessoa DROP CONSTRAINT IF EXISTS core_pessoa_pais_id_fkey")
        
        # Remove campo
        cursor.execute("ALTER TABLE core_pessoa DROP COLUMN pais")
        
        # Adiciona campo como varchar
        cursor.execute("ALTER TABLE core_pessoa ADD COLUMN pais VARCHAR(100)")


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0025_restructure_contacts"),
    ]

    operations = [
        migrations.RunPython(
            convert_pais_field_manually,
            reverse_convert_pais_field,
        ),
    ]