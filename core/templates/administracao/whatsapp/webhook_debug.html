{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'administracao:home' %}">Administração</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'administracao:whatsapp:dashboard' %}">WhatsApp Business</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'administracao:whatsapp:accounts_list' %}">Contas</a></li>
                    <li class="breadcrumb-item active">Diagnóstico Webhook</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-1">
                <i class="fas fa-stethoscope text-primary me-2"></i>
                Diagnóstico do Webhook
            </h1>
            <p class="text-muted">{{ account.name }} - {{ account.phone_number }}</p>
        </div>
    </div>

    <!-- Status do Webhook -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-link me-2"></i>
                    Configuração do Webhook
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">URL do Webhook:</label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" value="{{ webhook_url }}" readonly>
                            <button class="btn btn-outline-secondary" onclick="navigator.clipboard.writeText('{{ webhook_url }}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <small class="text-muted">Configure esta URL no Facebook/Meta Business</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Token de Verificação:</label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" value="{{ webhook_verify_token }}" readonly>
                            <button class="btn btn-outline-secondary" onclick="navigator.clipboard.writeText('{{ webhook_verify_token }}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <small class="text-muted">Use este token na configuração do webhook</small>
                    </div>

                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Como configurar:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Acesse o <a href="https://developers.facebook.com" target="_blank">Facebook for Developers</a></li>
                            <li>Vá para seu App → WhatsApp → Configuração</li>
                            <li>Em "Webhook", cole a URL e o token acima</li>
                            <li>Selecione os campos: messages, message_status</li>
                            <li>Clique em "Verificar e Salvar"</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-chart-bar me-2"></i>
                    Estatísticas do Webhook
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h3 class="text-primary">{{ webhook_stats.total }}</h3>
                            <small class="text-muted">Total Recebidos</small>
                        </div>
                        <div class="col-4">
                            <h3 class="text-info">{{ webhook_stats.last_24h }}</h3>
                            <small class="text-muted">Últimas 24h</small>
                        </div>
                        <div class="col-4">
                            <h3 class="text-warning">{{ webhook_stats.pending }}</h3>
                            <small class="text-muted">Pendentes</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-success">{{ webhook_stats.processed }}</h4>
                            <small class="text-muted">Processados</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-danger">{{ webhook_stats.failed }}</h4>
                            <small class="text-muted">Falharam</small>
                        </div>
                    </div>

                    {% if webhook_stats.pending > 0 %}
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Existem {{ webhook_stats.pending }} webhook(s) pendentes de processamento
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Teste de Conectividade -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-plug me-2"></i>
                    Teste de Conectividade
                </div>
                <div class="card-body">
                    <p>Clique no botão abaixo para testar se o webhook está configurado corretamente:</p>
                    <button class="btn btn-success" 
                            hx-post="{% url 'administracao:whatsapp:test_webhook' account.id %}"
                            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                            hx-target="#test-result"
                            hx-indicator="#test-spinner">
                        <i class="fas fa-vial me-2"></i>
                        Testar Webhook
                        <span id="test-spinner" class="spinner-border spinner-border-sm ms-2 htmx-indicator" role="status">
                            <span class="visually-hidden">Testando...</span>
                        </span>
                    </button>
                    <div id="test-result" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Últimos Webhooks Recebidos -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-history me-2"></i>
                    Últimos Webhooks Recebidos
                </div>
                <div class="card-body">
                    {% if recent_webhooks %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Status</th>
                                    <th>Tentativas</th>
                                    <th>Tipo</th>
                                    <th>Erro</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for webhook in recent_webhooks %}
                                <tr>
                                    <td>
                                        <small>{{ webhook.received_at|date:"d/m/Y H:i:s" }}</small>
                                    </td>
                                    <td>
                                        {% if webhook.status == 'processed' %}
                                            <span class="badge bg-success">Processado</span>
                                        {% elif webhook.status == 'pending' %}
                                            <span class="badge bg-warning">Pendente</span>
                                        {% elif webhook.status == 'processing' %}
                                            <span class="badge bg-info">Processando</span>
                                        {% else %}
                                            <span class="badge bg-danger">Falhou</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ webhook.attempts }}</td>
                                    <td>
                                        {% if webhook.payload.entry.0.changes.0.value.messages %}
                                            <span class="badge bg-primary">Mensagem</span>
                                        {% elif webhook.payload.entry.0.changes.0.value.statuses %}
                                            <span class="badge bg-secondary">Status</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark">Outro</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if webhook.error_message %}
                                            <small class="text-danger">{{ webhook.error_message|truncatechars:50 }}</small>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="showWebhookDetails({{ webhook.id }}, '{{ webhook.payload|escapejs }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-inbox text-muted fa-3x mb-3"></i>
                        <p class="text-muted">Nenhum webhook recebido ainda</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Últimas Mensagens Recebidas -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-comments me-2"></i>
                    Últimas Mensagens Recebidas
                </div>
                <div class="card-body">
                    {% if recent_messages %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Contato</th>
                                    <th>Tipo</th>
                                    <th>Conteúdo</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for message in recent_messages %}
                                <tr>
                                    <td>
                                        <small>{{ message.timestamp|date:"d/m/Y H:i:s" }}</small>
                                    </td>
                                    <td>{{ message.contact.display_name }}</td>
                                    <td>
                                        <span class="badge bg-secondary">{{ message.get_message_type_display }}</span>
                                    </td>
                                    <td>
                                        <small>{{ message.get_display_content|truncatechars:50 }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ message.get_status_display }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-comment-slash text-muted fa-3x mb-3"></i>
                        <p class="text-muted">Nenhuma mensagem recebida ainda</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalhes do Webhook -->
<div class="modal fade" id="webhookDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Webhook</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="webhook-payload" class="bg-light p-3 rounded"></pre>
            </div>
        </div>
    </div>
</div>

<script>
function showWebhookDetails(id, payload) {
    try {
        const parsed = JSON.parse(payload);
        document.getElementById('webhook-payload').textContent = JSON.stringify(parsed, null, 2);
        new bootstrap.Modal(document.getElementById('webhookDetailsModal')).show();
    } catch (e) {
        alert('Erro ao parsear payload do webhook');
    }
}
</script>
{% endblock %}