{% extends "base.html" %}
{% load static %}

{% block title %}Chat WhatsApp - {{ account.name }}{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- Lista de Contatos -->
        <div class="col-md-4 col-lg-3 bg-light border-end h-100" style="max-height: calc(100vh - 100px); overflow-y: auto;">
            <div class="p-3 border-bottom">
                <h5 class="mb-0">
                    <i class="fab fa-whatsapp text-success me-2"></i>
                    {{ account.name }}
                </h5>
                <small class="text-muted">{{ account.display_phone }}</small>
            </div>
            
            <div class="p-2">
                <input type="text" class="form-control" placeholder="Buscar contatos..." id="searchContacts">
            </div>
            
            <div class="list-group list-group-flush" id="contactsList">
                {% for contact in contacts %}
                <a href="#" class="list-group-item list-group-item-action contact-item" 
                   data-contact-id="{{ contact.id }}" data-contact-name="{{ contact.display_name }}">
                    <div class="d-flex w-100 justify-content-between">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">{{ contact.display_name }}</h6>
                            <p class="mb-1 text-muted small">{{ contact.display_phone }}</p>
                            {% if contact.last_message_time %}
                                <small class="text-muted">{{ contact.last_message_time|timesince }} atrás</small>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            {% if contact.unread_count > 0 %}
                                <span class="badge bg-success rounded-pill">{{ contact.unread_count }}</span>
                            {% endif %}
                            {% if contact.is_business %}
                                <i class="fas fa-building text-primary" title="Empresa"></i>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% empty %}
                <div class="p-3 text-center text-muted">
                    <i class="fas fa-comments fa-3x mb-3 d-block"></i>
                    <p>Nenhum contato com mensagens ainda.</p>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Área de Chat -->
        <div class="col-md-8 col-lg-9 d-flex flex-column h-100" id="chatArea">
            <div class="flex-grow-1 d-flex align-items-center justify-content-center text-muted">
                <div class="text-center">
                    <i class="fab fa-whatsapp fa-5x mb-3 text-success"></i>
                    <h4>WhatsApp Web</h4>
                    <p>Selecione um contato para iniciar a conversa</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template para área de chat -->
<template id="chatTemplate">
    <div class="chat-container d-flex flex-column h-100">
        <!-- Cabeçalho do Chat -->
        <div class="chat-header bg-white border-bottom p-3">
            <div class="d-flex align-items-center">
                <div class="avatar me-3">
                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        <i class="fas fa-user text-white"></i>
                    </div>
                </div>
                <div class="flex-grow-1">
                    <h6 class="mb-0 contact-name">Nome do Contato</h6>
                    <small class="text-muted contact-phone">+55 11 99999-9999</small>
                </div>
                <div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadContactInfo()">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mensagens -->
        <div class="chat-messages flex-grow-1 p-3" style="overflow-y: auto; max-height: calc(100vh - 250px);" id="messagesContainer">
            <!-- Mensagens serão carregadas aqui via JavaScript -->
        </div>
        
        <!-- Input de Mensagem -->
        <div class="chat-input border-top p-3">
            <form id="messageForm" class="d-flex align-items-center">
                <input type="hidden" id="currentContactId">
                <div class="flex-grow-1 me-2">
                    <input type="text" class="form-control" id="messageInput" 
                           placeholder="Digite sua mensagem..." autocomplete="off">
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>
</template>

<script>
let currentContactId = null;
let ws = null;
const accountId = {{ account.id }};

// Conecta WebSocket
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/whatsapp/${accountId}/`;
    
    ws = new WebSocket(wsUrl);
    
    ws.onopen = function(event) {
        console.log('WebSocket conectado');
    };
    
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        handleWebSocketMessage(data);
    };
    
    ws.onclose = function(event) {
        console.log('WebSocket desconectado');
        // Reconecta após 3 segundos
        setTimeout(connectWebSocket, 3000);
    };
    
    ws.onerror = function(error) {
        console.error('Erro no WebSocket:', error);
    };
}

// Trata mensagens do WebSocket
function handleWebSocketMessage(data) {
    switch(data.type) {
        case 'message_received':
            addMessageToChat(data.message);
            break;
        case 'message_sent':
            addMessageToChat(data.message);
            break;
        case 'message_status_update':
            updateMessageStatus(data.message_id, data.status);
            break;
        case 'typing_status':
            showTypingIndicator(data.contact_id, data.is_typing);
            break;
    }
}

// Seleciona contato
document.addEventListener('click', function(e) {
    if (e.target.closest('.contact-item')) {
        e.preventDefault();
        const contactItem = e.target.closest('.contact-item');
        const contactId = contactItem.dataset.contactId;
        const contactName = contactItem.dataset.contactName;
        
        selectContact(contactId, contactName);
    }
});

// Seleciona contato e carrega chat
function selectContact(contactId, contactName) {
    currentContactId = contactId;
    
    // Remove seleção anterior
    document.querySelectorAll('.contact-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Marca contato atual como ativo
    document.querySelector(`[data-contact-id="${contactId}"]`).classList.add('active');
    
    // Carrega interface de chat
    loadChatInterface(contactId, contactName);
}

// Carrega interface de chat
function loadChatInterface(contactId, contactName) {
    const chatArea = document.getElementById('chatArea');
    const template = document.getElementById('chatTemplate');
    const chatHtml = template.content.cloneNode(true);
    
    // Preenche dados do contato
    chatHtml.querySelector('.contact-name').textContent = contactName;
    chatHtml.querySelector('#currentContactId').value = contactId;
    
    // Limpa e adiciona novo chat
    chatArea.innerHTML = '';
    chatArea.appendChild(chatHtml);
    
    // Carrega histórico de mensagens
    loadMessageHistory(contactId);
    
    // Configura envio de mensagens
    setupMessageForm();
}

// Carrega histórico de mensagens
function loadMessageHistory(contactId) {
    fetch(`/administracao/whatsapp/contact/${contactId}/`)
        .then(response => response.text())
        .then(html => {
            // Extrai mensagens do HTML (implementação simplificada)
            // Em uma implementação real, usar API JSON
            console.log('Histórico carregado');
        })
        .catch(error => {
            console.error('Erro ao carregar histórico:', error);
        });
}

// Configura formulário de mensagem
function setupMessageForm() {
    const form = document.getElementById('messageForm');
    const input = document.getElementById('messageInput');
    
    form.onsubmit = function(e) {
        e.preventDefault();
        const message = input.value.trim();
        const contactId = document.getElementById('currentContactId').value;
        
        if (message && contactId) {
            sendMessage(contactId, message);
            input.value = '';
        }
    };
}

// Envia mensagem
function sendMessage(contactId, message) {
    fetch('/administracao/whatsapp/api/send-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            contact_id: contactId,
            message: message,
            type: 'text'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Erro ao enviar mensagem: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro ao enviar mensagem:', error);
        alert('Erro ao enviar mensagem');
    });
}

// Adiciona mensagem ao chat
function addMessageToChat(message) {
    const messagesContainer = document.getElementById('messagesContainer');
    if (!messagesContainer) return;
    
    const messageHtml = `
        <div class="message ${message.direction === 'outbound' ? 'sent' : 'received'} mb-3">
            <div class="message-content">
                <div class="message-text p-2 rounded ${message.direction === 'outbound' ? 'bg-primary text-white ms-auto' : 'bg-light'}" style="max-width: 70%;">
                    ${message.content}
                </div>
                <small class="text-muted d-block mt-1 ${message.direction === 'outbound' ? 'text-end' : ''}">
                    ${new Date(message.timestamp).toLocaleTimeString()}
                    ${message.direction === 'outbound' ? '<i class="fas fa-check text-success ms-1"></i>' : ''}
                </small>
            </div>
        </div>
    `;
    
    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Inicializa ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
});
</script>

{% csrf_token %}
{% endblock %}