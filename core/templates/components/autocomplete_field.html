{% load crispy_forms_tags %}

<!-- Campo de autocomplete reutilizável -->
<div class="position-relative">
    <!-- Campo de busca visível -->
    <div class="mb-3">
        <label class="form-label">{{ search_field.label }}</label>
        {{ search_field }}
        {% if hidden_field.errors %}
            <div class="invalid-feedback d-block">
                {% for error in hidden_field.errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}
        {% if search_field.errors %}
            <div class="invalid-feedback d-block">
                {% for error in search_field.errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}
        <div class="form-text">{{ hidden_field.help_text }}</div>
    </div>
    
    <!-- Campo hidden para ID -->
    {{ hidden_field }}
    
    <!-- Container para resultados do autocomplete -->
    <div id="{{ search_field.id_for_label }}-autocomplete-results" 
         class="autocomplete-results border rounded bg-white position-absolute w-100 shadow-sm"
         style="display: none; z-index: 1000; max-height: 300px; overflow-y: auto;"
         hx-get="{{ search_url }}"
         hx-trigger="keyup changed delay:500ms from:#{{ search_field.id_for_label }}"
         hx-include="#{{ search_field.id_for_label }}{% if include_params %},{{ include_params }}{% endif %}"
         hx-target="#{{ search_field.id_for_label }}-autocomplete-results"
         hx-swap="innerHTML">
    </div>
    
    <!-- Pessoa selecionada -->
    <div id="{{ search_field.id_for_label }}-selecionada" class="mt-2" style="display: none;">
        <div class="alert alert-success d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-check-circle me-2"></i>
                <strong>{{ selected_label|default:"Item selecionado:" }}</strong>
                <span id="{{ search_field.id_for_label }}-nome-selecionado"></span>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger autocomplete-clear-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</div>

<script>
    // Inicializa autocomplete para este campo específico
    (function() {
        const searchInput = document.getElementById('{{ search_field.id_for_label }}');
        const hiddenInput = document.getElementById('{{ hidden_field.id_for_label }}');
        const resultsContainer = document.getElementById('{{ search_field.id_for_label }}-autocomplete-results');
        const selectedDisplay = document.getElementById('{{ search_field.id_for_label }}-selecionada');
        const selectedText = document.getElementById('{{ search_field.id_for_label }}-nome-selecionado');
        const clearButton = selectedDisplay?.querySelector('.autocomplete-clear-btn');
        
        // Configura HTMX para enviar o valor como 'q'
        if (resultsContainer) {
            resultsContainer.addEventListener('htmx:configRequest', function(evt) {
                evt.detail.parameters['q'] = searchInput.value;
                // Remove o parâmetro com o nome do campo
                delete evt.detail.parameters['{{ search_field.name }}'];
            });
        }
        
        if (searchInput && hiddenInput && resultsContainer && window.AutocompleteField) {
            const autocomplete = new AutocompleteField({
                searchInput: searchInput,
                hiddenInput: hiddenInput,
                resultsContainer: resultsContainer,
                selectedDisplay: selectedDisplay,
                selectedText: selectedText,
                clearButton: clearButton
            });
            
            // Sobrescreve as funções globais para compatibilidade
            window.selecionarPessoa = function(pessoaId, pessoaNome, pessoaDoc) {
                autocomplete.defaultOnSelect(pessoaId, pessoaNome, pessoaDoc);
            };
            
            window.limparSelecaoPessoa = function() {
                autocomplete.clearSelection();
            };
        }
    })();
</script>