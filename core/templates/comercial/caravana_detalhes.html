{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            {% url 'comercial:caravanas_disponiveis' as caravanas_url %}
            {% include 'includes/breadcrumbs.html' with prev_page="Caravanas Dispon√≠veis" prev_url=caravanas_url cur_page=caravana.nome %}
        </div>
    </div>
    
    <!-- Cabe√ßalho da Caravana -->
    <div class="row mb-4">
        <div class="col">
            <div class="card border-0 shadow-sm bg-primary text-white">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col">
                            <h1 class="h2 mb-2">
                                <i class="fas fa-bus me-3"></i>
                                {{ caravana.nome }}
                            </h1>
                            <p class="mb-0 opacity-75">
                                <i class="fas fa-building me-2"></i>
                                {{ caravana.empresa.nome }}
                            </p>
                        </div>
                        <div class="col-auto">
                            <div class="text-center">
                                <h4 class="mb-0">
                                    <span class="text-success">{{ passageiros_disponiveis }}</span>
                                    <span class="opacity-75">/</span>
                                    <span>{{ caravana.quantidade }}</span>
                                </h4>
                                <small class="opacity-75">Dispon√≠veis/Total</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Informa√ß√µes da Caravana -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informa√ß√µes Gerais
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted d-block">Tipo</small>
                        <span class="badge bg-secondary">{{ caravana.get_tipo_display }}</span>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Data do Contrato</small>
                        <strong>{{ caravana.data_contrato|date:"d/m/Y" }}</strong>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Promotor</small>
                        <strong>{{ caravana.promotor.nome }}</strong>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted d-block">Respons√°vel</small>
                        <strong>{{ caravana.responsavel.nome }}</strong>
                    </div>
                    
                    {% if caravana.lideres.exists %}
                    <div class="mb-3">
                        <small class="text-muted d-block">L√≠deres</small>
                        {% for lider in caravana.lideres.all %}
                            <span class="badge bg-info me-1 mb-1">{{ lider.nome }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>

        <!-- Bloqueios Dispon√≠veis -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Bloqueios Dispon√≠veis
                    </h5>
                </div>
                <div class="card-body">
                    {% if bloqueios %}
                    <div class="row g-3">
                        {% for bloqueio in bloqueios %}
                        <div class="col-md-6">
                            <div class="card border">
                                <div class="card-body">
                                    <!-- Valor Total Convertido em Destaque -->
                                    {% if bloqueio.moeda_valor == 'USD' or bloqueio.moeda_taxas == 'USD' %}
                                    {% if dolar_hoje %}
                                    <div class="text-center mb-3 p-3 bg-success bg-opacity-10 rounded border border-success border-opacity-25">
                                        <div class="text-success fw-bold small mb-1">üí∞ VALOR TOTAL</div>
                                        <div class="fs-2 fw-bold text-success mb-1">
                                            R$ 
                                            {% if bloqueio.moeda_valor == 'USD' and bloqueio.moeda_taxas == 'USD' %}
                                                {% widthratio bloqueio.valor 1 dolar_hoje as valor_convertido %}
                                                {% widthratio bloqueio.taxas 1 dolar_hoje as taxas_convertidas %}
                                                {{ valor_convertido|add:taxas_convertidas|floatformat:2 }}
                                            {% elif bloqueio.moeda_valor == 'USD' %}
                                                {% widthratio bloqueio.valor 1 dolar_hoje as valor_convertido %}
                                                {{ valor_convertido|add:bloqueio.taxas|floatformat:2 }}
                                            {% else %}
                                                {% widthratio bloqueio.taxas 1 dolar_hoje as taxas_convertidas %}
                                                {{ bloqueio.valor|add:taxas_convertidas|floatformat:2 }}
                                            {% endif %}
                                        </div>
                                        <small class="text-success fw-semibold">por passageiro</small>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                    
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">{{ bloqueio.descricao }}</h6>
                                        <span class="badge bg-primary">#{{ bloqueio.id }}</span>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <small class="text-muted">Data de Sa√≠da</small>
                                        <div class="fw-bold">
                                            {{ bloqueio.saida|date:"d/m/Y" }}
                                        </div>
                                    </div>

                                    {% if bloqueio.paises.exists %}
                                    <div class="mb-2">
                                        <small class="text-muted d-block">Destinos</small>
                                        {% for pais in bloqueio.paises.all %}
                                            <span class="badge bg-outline-secondary me-1">{{ pais.nome }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}

                                    <div class="mb-3">
                                        <div class="row text-center small">
                                            <div class="col-6">
                                                <div class="border-end">
                                                    <div class="text-muted">{{ bloqueio.get_moeda_valor_display }} {{ bloqueio.valor|floatformat:2 }}</div>
                                                    <small class="text-muted">Valor</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="text-muted">{{ bloqueio.get_moeda_taxas_display }} {{ bloqueio.taxas|floatformat:2 }}</div>
                                                <small class="text-muted">Taxas</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-info btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#bloqueioModal{{ bloqueio.id }}">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Ver Detalhes
                                        </button>
                                        <button class="btn btn-primary btn-sm bloqueio-select-btn" 
                                                data-bloqueio-id="{{ bloqueio.id }}"
                                                data-bloqueio-nome="{{ bloqueio.descricao }}"
                                                onclick="selecionarBloqueio(this)">
                                            <i class="fas fa-check-circle me-2"></i>
                                            Selecionar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">Nenhum bloqueio dispon√≠vel</h6>
                        <p class="text-muted small">
                            Esta caravana ainda n√£o possui bloqueios configurados para venda.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Configura√ß√£o da Venda -->
    {% if bloqueios %}
    <div class="row mt-4">
        <div class="col">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <i class="fas fa-cog me-2"></i>
                        Configura√ß√£o da Venda
                    </h6>
                    
                    <div class="row align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Quantidade de Passageiros</label>
                            <select class="form-select" id="quantidadeSelect" onchange="verificarSelecao()">
                                <option value="">Selecione a quantidade</option>
                                {% for num in quantidade_range %}
                                    <option value="{{ num }}">{{ num }} passageiro{% if num > 1 %}s{% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Bloqueio Selecionado</label>
                            <div id="bloqueioSelecionado" class="form-control bg-white text-muted">
                                Nenhum bloqueio selecionado
                            </div>
                        </div>
                        
                        <div class="col-md-2">
                            <button id="btnIniciarVenda" class="btn btn-success w-100" disabled>
                                <i class="fas fa-shopping-cart me-2"></i>
                                Iniciar Venda
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- A√ß√µes -->
    <div class="row mt-4">
        <div class="col">
            <a href="{% url 'comercial:caravanas_disponiveis' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Voltar √†s Caravanas
            </a>
        </div>
    </div>

    <!-- Modais dos Bloqueios -->
    {% for bloqueio in bloqueios %}
    <div class="modal fade" id="bloqueioModal{{ bloqueio.id }}" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-calendar-alt me-2"></i>
                        {{ bloqueio.descricao }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Valor Total em Destaque no Modal -->
                    {% if bloqueio.moeda_valor == 'USD' or bloqueio.moeda_taxas == 'USD' %}
                    {% if dolar_hoje %}
                    <div class="text-center mb-4 p-4 bg-success bg-opacity-15 rounded border border-success">
                        <div class="text-success fw-bold mb-2">üí∞ VALOR TOTAL POR PASSAGEIRO</div>
                        <div class="display-4 fw-bold text-success mb-2">
                            R$ 
                            {% if bloqueio.moeda_valor == 'USD' and bloqueio.moeda_taxas == 'USD' %}
                                {% widthratio bloqueio.valor 1 dolar_hoje as valor_convertido %}
                                {% widthratio bloqueio.taxas 1 dolar_hoje as taxas_convertidas %}
                                {{ valor_convertido|add:taxas_convertidas|floatformat:2 }}
                            {% elif bloqueio.moeda_valor == 'USD' %}
                                {% widthratio bloqueio.valor 1 dolar_hoje as valor_convertido %}
                                {{ valor_convertido|add:bloqueio.taxas|floatformat:2 }}
                            {% else %}
                                {% widthratio bloqueio.taxas 1 dolar_hoje as taxas_convertidas %}
                                {{ bloqueio.valor|add:taxas_convertidas|floatformat:2 }}
                            {% endif %}
                        </div>
                        <div class="text-success">
                            <i class="fas fa-check-circle me-1"></i>
                            Valor convertido automaticamente
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <h6>Informa√ß√µes Gerais</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Data de Sa√≠da:</strong></td>
                                    <td>{{ bloqueio.saida|date:"d/m/Y" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Valor:</strong></td>
                                    <td>{{ bloqueio.get_moeda_valor_display }} {{ bloqueio.valor|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Taxas:</strong></td>
                                    <td>{{ bloqueio.get_moeda_taxas_display }} {{ bloqueio.taxas|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Terrestre:</strong></td>
                                    <td>{% if bloqueio.terrestre %}Sim{% else %}N√£o{% endif %}</td>
                                </tr>
                            </table>
                            
                        </div>
                        
                        <div class="col-md-6">
                            {% if bloqueio.paises.exists %}
                            <h6>Destinos</h6>
                            <div class="mb-3">
                                {% for pais in bloqueio.paises.all %}
                                    <span class="badge bg-primary me-1 mb-1">{{ pais.nome }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            {% if bloqueio.hoteis.exists %}
                            <h6>Hot√©is</h6>
                            <div class="mb-3">
                                {% for hotel in bloqueio.hoteis.all %}
                                    <div class="small text-muted">{{ hotel.nome }} - {{ hotel.cidade.nome }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            {% if bloqueio.inclusos.exists %}
                            <h6>Inclusos</h6>
                            <div class="mb-3">
                                {% for incluso in bloqueio.inclusos.all %}
                                    <span class="badge bg-success me-1 mb-1">{{ incluso.nome }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" 
                            onclick="selecionarBloqueioModal({{ bloqueio.id }}, '{{ bloqueio.descricao }}')" 
                            data-bs-dismiss="modal">
                        <i class="fas fa-check-circle me-2"></i>
                        Selecionar Este Bloqueio
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
let bloqueioSelecionado = null;

function selecionarBloqueio(button) {
    // Remove sele√ß√£o anterior
    document.querySelectorAll('.bloqueio-select-btn').forEach(btn => {
        btn.classList.remove('btn-success');
        btn.classList.add('btn-primary');
        btn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Selecionar';
    });
    
    // Marca o atual como selecionado
    button.classList.remove('btn-primary');
    button.classList.add('btn-success');
    button.innerHTML = '<i class="fas fa-check me-2"></i>Selecionado';
    
    // Atualiza vari√°vel global
    bloqueioSelecionado = {
        id: button.dataset.bloqueioId,
        nome: button.dataset.bloqueioNome
    };
    
    // Atualiza exibi√ß√£o
    document.getElementById('bloqueioSelecionado').innerHTML = 
        `<strong>${bloqueioSelecionado.nome}</strong> <small class="text-muted">(ID: ${bloqueioSelecionado.id})</small>`;
    document.getElementById('bloqueioSelecionado').classList.remove('text-muted');
    document.getElementById('bloqueioSelecionado').classList.add('text-dark');
    
    verificarSelecao();
}

function selecionarBloqueioModal(id, nome) {
    // Encontra o bot√£o correspondente e simula o clique
    const button = document.querySelector(`[data-bloqueio-id="${id}"]`);
    if (button) {
        selecionarBloqueio(button);
    }
}

function verificarSelecao() {
    const quantidade = document.getElementById('quantidadeSelect').value;
    const btnIniciar = document.getElementById('btnIniciarVenda');
    
    if (bloqueioSelecionado && quantidade) {
        btnIniciar.disabled = false;
        btnIniciar.classList.remove('btn-secondary');
        btnIniciar.classList.add('btn-success');
    } else {
        btnIniciar.disabled = true;
        btnIniciar.classList.remove('btn-success');
        btnIniciar.classList.add('btn-secondary');
    }
}

// Fun√ß√£o para iniciar venda
function iniciarVenda() {
    if (!bloqueioSelecionado) {
        alert('Por favor, selecione um bloqueio primeiro.');
        return;
    }
    
    const quantidade = document.getElementById('quantidadeSelect').value;
    if (!quantidade) {
        alert('Por favor, selecione a quantidade de passageiros.');
        return;
    }
    
    // Redirecionar para p√°gina de nova venda com par√¢metros
    const url = `/comercial/nova-venda/caravanas/{{ caravana.id }}/?bloqueio=${bloqueioSelecionado.id}&quantidade=${quantidade}`;
    window.location.href = url;
}

// Adicionar evento ao bot√£o
document.addEventListener('DOMContentLoaded', function() {
    const btnIniciar = document.getElementById('btnIniciarVenda');
    if (btnIniciar) {
        btnIniciar.addEventListener('click', iniciarVenda);
    }
});
</script>
{% endblock %}