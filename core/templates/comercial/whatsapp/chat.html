{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    /* Layout do Chat */
    .chat-container {
        background: #f0f2f5;
        flex: 1;
        height: calc(100vh - 200px); /* Altura fixa baseada no viewport */
        max-height: calc(100vh - 200px);
        overflow: hidden;
    }
    
    /* Lista de Contatos */
    .contacts-sidebar {
        width: 30%;
        min-width: 300px;
        background: white;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 200px); /* Altura fixa igual ao chat-container */
        max-height: calc(100vh - 200px);
        overflow: hidden;
    }
    
    .contacts-header {
        padding: 15px;
        background: #f0f2f5;
        border-bottom: 1px solid #ddd;
        flex-shrink: 0;
    }
    
    .contacts-list {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 0;
    }
    
    .contact-item {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f2f5;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .contact-item:hover {
        background: #f5f5f5;
    }
    
    .contact-item.active {
        background: #e9f3fb;
    }
    
    /* Mobile contact list improvements */
    @media (max-width: 767.98px) {
        .contact-item {
            padding: 0;
            border-bottom: none;
        }
        
        .contact-item .btn {
            border-radius: 0;
            transition: background-color 0.2s;
        }
        
        .contact-item .btn:hover {
            background-color: #f8f9fa !important;
        }
        
        .contact-item .btn:active {
            background-color: #e9ecef !important;
        }
        
        .contact-avatar {
            width: 50px;
            height: 50px;
            font-size: 1.1rem;
        }
        
        /* For√ßa truncate em mobile */
        .contact-item .btn {
            min-width: 0;
            max-width: 100%;
        }
        
        .contact-item .flex-grow-1 {
            min-width: 0;
            overflow: hidden;
        }
    }
    
    .contact-avatar {
        width: 45px;
        height: 45px;
        background: #25d366;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 18px;
    }
    
    /* √Årea de Conversa */
    .chat-area {
        background: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='a' patternUnits='userSpaceOnUse' width='100' height='100'%3E%3Cpath fill='%23e5ddd5' d='M0 0h100v100H0z'/%3E%3Cpath fill='%23ddd6ce' opacity='.5' d='M0 0l50 50-50 50m50-100l50 50-50 50'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23a)'/%3E%3C/svg%3E");
        height: calc(100vh - 200px); /* Altura fixa independente da sidebar */
        max-height: calc(100vh - 200px);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        padding: 15px;
        background: #f0f2f5;
        border-bottom: 1px solid #ddd;
        flex-shrink: 0;
    }
    
    .messages-container {
        padding: 20px;
        height: 0; /* Permite que flex-fill funcione corretamente */
        min-height: 0; /* Permite que o scroll funcione */
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
        -webkit-overflow-scrolling: touch;
    }
    
    .message {
        max-width: 60%;
        margin-bottom: 10px;
        clear: both;
    }
    
    .message-bubble {
        padding: 8px 12px;
        border-radius: 7px;
        position: relative;
        word-wrap: break-word;
    }
    
    .message.inbound {
        float: left;
    }
    
    .message.inbound .message-bubble {
        background: white;
        border: 1px solid #ddd;
    }
    
    .message.outbound {
        float: right;
    }
    
    .message.outbound .message-bubble {
        background: #dcf8c6;
        border: 1px solid #34b7f1;
    }
    
    .message-time {
        font-size: 11px;
        color: #999;
        margin-top: 2px;
    }
    
    .chat-input {
        padding: 15px;
        background: #f0f2f5;
        border-top: 1px solid #ddd;
        z-index: 10;
        flex-shrink: 0;
        width: 100%;
        margin-top: auto;
    }

    .chat-input-fixed {
        padding: 15px;
        background: #f0f2f5;
        border-top: 1px solid #ddd;
        z-index: 1050;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-left: 8px;
        vertical-align: middle;
    }
    
    .status-online {
        background: #25d366;
        animation: pulse 2s infinite;
    }
    
    .status-offline {
        background: #dc3545;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    /* Bot√£o flutuante para ir ao final da conversa */
    .scroll-to-bottom {
        position: fixed;
        bottom: 120px;
        right: 30px;
        width: 50px;
        height: 50px;
        background: #25d366;
        border: none;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        color: white;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 1000;
        display: none;
    }
    
    .scroll-to-bottom:hover {
        background: #1ebe57;
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(37, 211, 102, 0.5);
    }
    
    .scroll-to-bottom.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: bounceIn 0.3s ease;
    }
    
    @keyframes bounceIn {
        0% {
            opacity: 0;
            transform: scale(0.3);
        }
        50% {
            opacity: 1;
            transform: scale(1.1);
        }
        100% {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    .new-conversations-btn {
        position: relative;
    }
    
    /* Loading indicator para busca */
    .htmx-indicator {
        display: none;
    }
    
    .htmx-request .htmx-indicator {
        display: inline-block;
    }
    
    .htmx-request .fas.fa-search {
        display: none;
    }
    
    /* Responsividade Mobile */
    @media (max-width: 767.98px) {
        /* Layout viewport completo */
        .page-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header-section {
            flex-shrink: 0;
        }
        
        .content-section {
            flex: 1;
            overflow: hidden;
        }
        
        .chat-container {
            height: calc(100vh - 140px); /* Ajuste para mobile */
            max-height: calc(100vh - 140px);
        }
        
        .contacts-sidebar {
            width: 100%;
            min-width: auto;
            height: calc(100vh - 140px);
            max-height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-area {
            height: calc(100vh - 140px);
            max-height: calc(100vh - 140px);
        }
        
        /* Ajuste do bot√£o para mobile */
        .scroll-to-bottom {
            bottom: 80px;
            right: 20px;
            width: 45px;
            height: 45px;
            font-size: 18px;
        }
        
        .contacts-header {
            flex-shrink: 0;
        }
        
        .contacts-list {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }
        
        .message {
            max-width: 85%;
        }
        
        .messages-container {
            padding: 10px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            flex: 1;
            min-height: 0;
        }
        
        .chat-input {
            padding: 10px;
            flex-shrink: 0;
            width: 100%;
            background: #f0f2f5;
            border-top: 1px solid #ddd;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Container de Mensagens HTMX (fixo no topo) -->
<div id="htmx-messages" class="position-fixed top-0 end-0 p-3" style="z-index: 1060;">
    <!-- Mensagens HTMX aparecer√£o aqui -->
</div>

<div class="page-container d-flex flex-column h-100">
    <!-- Header Section -->
    <div class="header-section flex-shrink-0">
        <!-- Breadcrumb -->
        <div class="bg-white border-bottom px-3 pt-3 pb-2 d-none d-md-block">
            {% include 'includes/breadcrumbs.html' %}
        </div>

        <!-- Header -->
        <div class="bg-white border-bottom p-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <h4 class="mb-0 d-flex align-items-center">
                        <i class="fab fa-whatsapp text-success me-2"></i>
                        WhatsApp Business
                        <span class="status-indicator status-online" id="connection-status" title="Conectado"></span>
                    </h4>
                </div>
                <button class="btn btn-primary new-conversations-btn" 
                        data-bs-toggle="modal" 
                        data-bs-target="#newConversationsModal"
                        hx-get="{% url 'comercial:pending_conversations' %}"
                        hx-target="#pending-conversations-container"
                        hx-swap="innerHTML"
                        hx-trigger="click"
                        title="Novas Conversas">
                    <i class="fas fa-user-plus d-md-none me-1"></i>
                    <span class="d-none d-md-inline">Novas Conversas</span>
                    <span class="badge ms-2" id="pending-badge"
                          style="background-color: {% if pending_count > 0 %}#dc3545{% else %}#6c757d{% endif %}; color: white;">
                        {{ pending_count|default:0 }}
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Content Section -->
    <div class="content-section flex-fill">
        <!-- Chat Container -->
        <div class="chat-container d-flex h-100 overflow-hidden">
        <!-- Sidebar de Contatos -->
        <div class="contacts-sidebar">
            <div class="contacts-header">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Buscar conversa..." 
                           name="search" 
                           hx-get="{% url 'comercial:my_conversations' %}"
                           hx-trigger="input changed delay:300ms"
                           hx-target="#contacts-list"
                           hx-indicator="#search-indicator">
                    <span class="input-group-text" id="search-indicator">
                        <i class="fas fa-search"></i>
                        <i class="fas fa-spinner fa-spin htmx-indicator"></i>
                    </span>
                </div>
            </div>
            
            <div class="contacts-list" id="contacts-list"
                 hx-get="{% url 'comercial:my_conversations' %}"
                 hx-trigger="load">
                <!-- Conversas carregadas via HTMX -->
                <div class="text-center p-3">
                    <i class="fas fa-spinner fa-spin"></i>
                    <small class="d-block mt-2 text-muted">Carregando conversas...</small>
                </div>
            </div>
        </div>

        <!-- √Årea de Chat - Desktop -->
        <div class="chat-area d-flex flex-column flex-fill d-none d-md-flex" id="chat-area">
            {% include 'comercial/whatsapp/partials/chat_area.html' %}
        </div>
        </div>
    </div>
</div>

<!-- Bot√£o flutuante para ir ao final da conversa -->
<button class="scroll-to-bottom" id="scrollToBottom" onclick="scrollToBottomChat()" title="Ir para o final da conversa">
    <i class="fas fa-chevron-down"></i>
</button>

<!-- Offcanvas para Chat Mobile - Estrutura fixa -->
<div class="offcanvas offcanvas-end d-md-none" tabindex="-1" id="mobileConversationOffcanvas" data-bs-backdrop="static" data-bs-scroll="false" style="width: 100vw;">
    <div class="offcanvas-header">
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Voltar"></button>
        <div class="d-flex align-items-center flex-grow-1 ms-2">
            <div class="contact-avatar me-3">?</div>
            <div class="flex-grow-1">
                <h6 class="mb-0">Selecione uma conversa</h6>
                <small class="text-muted"></small>
            </div>
            <div class="d-flex gap-1">
                <!-- A√ß√µes ser√£o preenchidas -->
            </div>
        </div>
    </div>
    <div class="offcanvas-body p-0">
        <!-- Conte√∫do din√¢mico ser√° carregado aqui -->
        <div id="mobileConversationContent">
            <div class="d-flex flex-column h-100">
                <div class="flex-fill d-flex align-items-center justify-content-center"
                     style="background: url('data:image/svg+xml;utf8,<svg width=\'100\' height=\'100\' xmlns=\'http://www.w3.org/2000/svg\'><defs><pattern id=\'a\' patternUnits=\'userSpaceOnUse\' width=\'100\' height=\'100\'><path fill=\'%23e5ddd5\' d=\'M0 0h100v100H0z\'/><path fill=\'%23ddd6ce\' opacity=\'.5\' d=\'M0 0l50 50-50 50m50-100l50 50-50 50\'/></pattern></defs><rect width=\'100%25\' height=\'100%25\' fill=\'url(%23a)\'/></svg>');">
                    <div class="text-center">
                        <i class="fab fa-whatsapp text-muted" style="font-size: 4rem;"></i>
                        <h5 class="mt-3 text-muted">Selecione uma conversa</h5>
                        <p class="text-muted">Escolha uma conversa da lista para come√ßar</p>
                    </div>
                </div>
                <div class="border-top p-3">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Selecione uma conversa..." disabled>
                        <button class="btn btn-secondary" type="button" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Novas Conversas -->
<div class="modal fade" id="newConversationsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-fullscreen-md-down">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>
                    <span class="d-none d-md-inline">Novas Conversas Aguardando Atendimento</span>
                    <span class="d-md-none">Novas Conversas</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="pending-conversations-container">
                <!-- Carregado via HTMX -->
            </div>
        </div>
    </div>
</div>

<!-- Modal de Data de Retorno -->
<div class="modal fade" id="dataRetornoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Definir Data de Retorno
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="dataRetornoForm" 
                  hx-post="{% url 'comercial:save_data_retorno' %}"
                  hx-target="#htmx-messages"
                  hx-swap="beforeend">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="conversation_id" value="{{ selected_conversation.id }}" id="dataRetornoConversationId">
                    <div class="mb-3">
                        <label for="dataRetorno" class="form-label">Data de Retorno <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="dataRetorno" name="data_retorno" required>
                        <div class="form-text">Selecione quando o cliente deve ser contatado novamente.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-calendar-check me-1"></i>
                        Salvar Data de Retorno
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Envio de Template -->
<div class="modal fade" id="sendTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-paper-plane me-2"></i>
                    Enviar Template
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="sendTemplateForm" 
                  hx-post="{% url 'comercial:send_template' %}"
                  hx-target="#templateFormResult"
                  hx-swap="innerHTML"
                  onsubmit="return validateTemplateForm(event)">
                <div class="modal-body">
                    <!-- Container para resultado do HTMX -->
                    <div id="templateFormResult"></div>
                    
                    {% csrf_token %}
                    <input type="hidden" name="conversation_id" value="{{ selected_conversation.id }}" id="sendTemplateConversationId">
                    <div class="mb-3">
                        <label for="templateSelect" class="form-label">Selecione o Template <span class="text-danger">*</span></label>
                        <select class="form-select" id="templateSelect" name="template_id" required
                                hx-get="{% url 'comercial:whatsapp_preview_template' %}"
                                hx-target="#templatePreview"
                                hx-trigger="change"
                                hx-include="this">
                            <option value="">Escolha um template...</option>
                            {% comment %}Templates ser√£o carregados via HTMX{% endcomment %}
                        </select>
                    </div>
                    <div id="templatePreview" class="mb-3">
                        <!-- Preview do template aparecer√° aqui -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane me-1"></i>
                        Enviar Template
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Envio de Documento PDF -->
<div class="modal fade" id="sendDocumentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-pdf me-2"></i>
                    Enviar Documento PDF
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Container para resultado do HTMX -->
                <div id="documentFormResult">
                    <!-- Formul√°rio inicial -->
                    <form hx-post="{% url 'comercial:send_document' %}" 
                          hx-target="#documentFormResult"
                          hx-swap="innerHTML"
                          hx-encoding="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="conversation_id" value="{{ selected_conversation.id }}" id="sendDocumentConversationId">
                        
                        <div class="mb-3">
                            <label for="documentFile" class="form-label">
                                Documento PDF <span class="text-danger">*</span>
                            </label>
                            <input type="file" class="form-control" id="documentFile" name="document" 
                                   accept=".pdf" required>
                            <div class="form-text">Arquivo PDF (m√°x. 16MB)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="documentCaption" class="form-label">Legenda (opcional)</label>
                            <textarea class="form-control" id="documentCaption" name="caption" 
                                      rows="2" placeholder="Adicione uma legenda ao documento..."></textarea>
                        </div>
                        
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-paper-plane me-1"></i>
                                Enviar Documento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Container para Modal de Novo Contato (carregado via HTMX) -->
<div id="modalNovoContatoContainer"
     hx-get="{% url 'comercial:whatsapp_novo_contato' %}"
     hx-trigger="load"
     hx-swap="innerHTML"></div>

<!-- Modal de Cadastro de Cliente -->
<div class="modal fade" id="clientRegistrationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>
                    Cadastrar Cliente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="clientRegistrationForm">
                    <div class="row">
                        <!-- Nome -->
                        <div class="col-md-8 mb-3">
                            <label for="clientName" class="form-label">Nome Completo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="clientName" name="nome" required>
                        </div>
                        
                        <!-- Tipo de Documento -->
                        <div class="col-md-4 mb-3">
                            <label for="clientTipoDoc" class="form-label">Tipo Documento <span class="text-danger">*</span></label>
                            <select class="form-select" id="clientTipoDoc" name="tipo_doc" required>
                                <option value="">Selecione...</option>
                                <option value="cpf">CPF</option>
                                <option value="cnpj">CNPJ</option>
                                <option value="passaporte">Passaporte</option>
                                <option value="rg">RG</option>
                            </select>
                        </div>
                        
                        <!-- Documento -->
                        <div class="col-md-6 mb-3">
                            <label for="clientDoc" class="form-label">Documento <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="clientDoc" name="doc" required>
                        </div>
                        
                        <!-- Email -->
                        <div class="col-md-6 mb-3">
                            <label for="clientEmail" class="form-label">E-mail <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="clientEmail" name="email" required>
                        </div>
                        
                        <!-- Telefone dividido -->
                        <div class="col-md-2 mb-3">
                            <label for="clientDdi" class="form-label">DDI <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="clientDdi" name="ddi" value="55" required>
                        </div>
                        
                        <div class="col-md-2 mb-3">
                            <label for="clientDdd" class="form-label">DDD <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="clientDdd" name="ddd" required>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="clientTelefone" class="form-label">Telefone <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="clientTelefone" name="telefone" required>
                        </div>
                        
                        <!-- CEP -->
                        <div class="col-md-6 mb-3">
                            <label for="clientCep" class="form-label">CEP</label>
                            <input type="text" class="form-control" id="clientCep" name="cep">
                        </div>
                        
                        <!-- Endere√ßo -->
                        <div class="col-md-8 mb-3">
                            <label for="clientEndereco" class="form-label">Endere√ßo</label>
                            <input type="text" class="form-control" id="clientEndereco" name="endereco">
                        </div>
                        
                        <!-- N√∫mero -->
                        <div class="col-md-4 mb-3">
                            <label for="clientNumero" class="form-label">N√∫mero</label>
                            <input type="text" class="form-control" id="clientNumero" name="numero">
                        </div>
                        
                        <!-- Complemento -->
                        <div class="col-md-4 mb-3">
                            <label for="clientComplemento" class="form-label">Complemento</label>
                            <input type="text" class="form-control" id="clientComplemento" name="complemento">
                        </div>
                        
                        <!-- Bairro -->
                        <div class="col-md-4 mb-3">
                            <label for="clientBairro" class="form-label">Bairro</label>
                            <input type="text" class="form-control" id="clientBairro" name="bairro">
                        </div>
                        
                        <!-- Cidade -->
                        <div class="col-md-4 mb-3">
                            <label for="clientCidade" class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="clientCidade" name="cidade">
                        </div>
                        
                        <!-- Estado -->
                        <div class="col-md-2 mb-3">
                            <label for="clientEstado" class="form-label">UF</label>
                            <input type="text" class="form-control" id="clientEstado" name="estado" maxlength="2">
                        </div>
                        
                        <!-- Pa√≠s -->
                        <div class="col-md-6 mb-3">
                            <label for="clientPais" class="form-label">Pa√≠s</label>
                            <input type="text" class="form-control" id="clientPais" name="pais" value="Brasil">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="saveClient()">
                    <i class="fas fa-save me-1"></i>
                    Cadastrar Cliente
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Busca de conversas implementada com HTMX

// Fun√ß√£o n√£o √© mais necess√°ria - bot√£o usa HTMX diretamente
// Mantida para compatibilidade se houver outras chamadas
function openNewConversationsModal() {
    const modal = new bootstrap.Modal(document.getElementById('newConversationsModal'));
    modal.show();
}

// Atribuir conversa
function assignConversation(conversationId) {
    fetch(`/comercial/whatsapp/assign/${conversationId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fecha modal
            bootstrap.Modal.getInstance(document.getElementById('newConversationsModal')).hide();
            
            // Atualiza lista de contatos (agora a conversa aparecer√° l√°)
            const contactsList = document.getElementById('contacts-list');
            if (contactsList) {
                htmx.trigger(contactsList, 'load');
            }
            
            // Redireciona para a conversa
            setTimeout(() => {
                window.location.href = `/comercial/whatsapp/?conversation=${conversationId}`;
            }, 500); // Pequeno delay para permitir atualiza√ß√£o da lista
        } else {
            alert('Erro ao atribuir conversa: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro ao atribuir conversa:', error);
        alert('Erro ao atribuir conversa.');
    });
}

// Fun√ß√£o para mostrar toast
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('htmx-messages');
    if (!toastContainer) return;
    
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div class="alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show" 
             role="alert" id="${toastId}">
            <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Remove automaticamente ap√≥s 5 segundos
    setTimeout(() => {
        const toast = document.getElementById(toastId);
        if (toast) toast.remove();
    }, 5000);
}

// Enviar mensagem com verifica√ß√£o de janela de 24h
function sendMessage(event, conversationId) {
    event.preventDefault();
    
    const input = document.getElementById('message-input');
    const sendButton = event.target.querySelector('button[type="submit"]');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Primeiro verifica a janela de 24h
    console.log('üïê Verificando janela de 24h antes de enviar mensagem...');
    
    // Desabilita bot√£o temporariamente
    input.disabled = true;
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch('/comercial/whatsapp/check-24h-window/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `conversation_id=${conversationId}`
    })
    .then(response => response.json())
    .then(data => {
        if (!data.within_24h_window) {
            // Fora da janela de 24h - mostra toast e n√£o envia
            const hoursText = data.hours_since_last_message ? 
                ` (${data.hours_since_last_message}h atr√°s)` : '';
            
            showToast(
                `‚è∞ Janela de 24h expirada${hoursText}. Envie um template primeiro para reabrir a conversa.`,
                'warning'
            );
            
            console.log('‚ùå Fora da janela de 24h - mensagem n√£o enviada');
            return;
        }
        
        // Dentro da janela - pode enviar mensagem normal
        console.log('‚úÖ Dentro da janela de 24h - enviando mensagem...');
        sendMessageNow(conversationId, message, input, sendButton);
    })
    .catch(error => {
        console.error('Erro ao verificar janela de 24h:', error);
        showToast('Erro ao verificar janela de 24h. Tente novamente.', 'error');
    })
    .finally(() => {
        // Reabilita bot√£o
        input.disabled = false;
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
        input.focus();
    });
}

// Fun√ß√£o separada para enviar mensagem (ap√≥s verifica√ß√£o)
function sendMessageNow(conversationId, message, input, sendButton) {
    // Desabilita novamente para envio
    input.disabled = true;
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch(`/comercial/whatsapp/send-message/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            conversation_id: conversationId,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            console.log(`Mensagem enviada - Status: ${data.status}, WAMID: ${data.wamid}`);
            
            // For√ßa atualiza√ß√£o das mensagens (HTMX afterSwap configurar√° o bot√£o automaticamente)
            htmx.ajax('GET', `/comercial/whatsapp/conversation/${conversationId}/messages/`, {
                target: '#messages-container',
                swap: 'innerHTML'
            });
            
        } else {
            showToast('Erro ao enviar mensagem: ' + (data.error || data.message || 'Erro desconhecido'), 'error');
            console.error('Erro ao enviar mensagem:', data);
        }
    })
    .catch(error => {
        console.error('Erro na requisi√ß√£o:', error);
        showToast('Erro de conex√£o ao enviar mensagem', 'error');
    })
    .finally(() => {
        // Reabilita bot√£o e input
        input.disabled = false;
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
        input.focus();
    });
}

// Fun√ß√£o finishConversation removida - conclus√£o ser√° feita em outro m√≥dulo

// WebSocket para notifica√ß√µes em tempo real
var socket = socket || null;

function connectWebSocket() {
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsPath = `${wsScheme}://${window.location.host}/ws/comercial/whatsapp/`;
    
    console.log('üîó Tentando conectar WebSocket:', wsPath);
    console.log('üåê Protocolo:', window.location.protocol);
    console.log('üè† Host:', window.location.host);
    
    try {
        socket = new WebSocket(wsPath);
        
        socket.onopen = function(e) {
            console.log('‚úÖ WebSocket conectado com sucesso!');
            console.log('üîç Socket state:', socket.readyState);
            console.log('üîç Socket URL:', socket.url);
            
            // Para polling se estiver ativo
            stopPolling();
            
            // Atualiza indicador de status
            const statusIndicator = document.getElementById('connection-status');
            if (statusIndicator) {
                statusIndicator.className = 'status-indicator status-online';
                statusIndicator.title = 'Conectado via WebSocket';
            }
            
            // WebSocket conectado silenciosamente
            console.log('‚úÖ Conex√£o estabelecida');
        };
    } catch (error) {
        console.error('‚ùå Erro ao criar WebSocket:', error);
        // Se falhar na cria√ß√£o, usa polling
        startPolling();
    }
    
    socket.onerror = function(error) {
        console.error('‚ùå Erro no WebSocket:', error);
        console.log('üîç Socket state no erro:', socket ? socket.readyState : 'socket is null');
        
        // Atualiza indicador de status
        const statusIndicator = document.getElementById('connection-status');
        if (statusIndicator) {
            statusIndicator.className = 'status-indicator status-error';
            statusIndicator.title = 'Erro na conex√£o WebSocket';
        }
        
        console.error('‚ùå Erro na conex√£o WebSocket');
    };
    
    socket.onmessage = function(event) {
        console.log('üì® WebSocket recebeu mensagem:', event.data);
        
        try {
            const data = JSON.parse(event.data);
            console.log('üìã Dados parsados:', data);
            console.log('üîÑ Tipo de evento:', data.type);
            
            switch(data.type) {
                case 'conversation_new':
                    console.log('üÜï Nova conversa recebida:', data.conversation);
                    // Atualiza tudo em um s√≥ evento
                    handleNewConversation(data.conversation);
                    if (data.pending_count !== undefined) {
                        updatePendingCount(data.pending_count);
                    }
                    updateModalIfOpen();
                    console.log('üìù Nova conversa aguardando atendimento');
                    break;
                case 'pending_count_update':
                    console.log('üìä Atualiza√ß√£o de contador:', data.count);
                    // Para outros casos que s√≥ atualizam contador
                    updatePendingCount(data.count);
                    updateModalIfOpen();
                    break;
                case 'conversation_assigned':
                    console.log('üë§ Conversa atribu√≠da:', data.conversation);
                    // Atualiza lista de conversas
                    const contactsListAssigned = document.getElementById('contacts-list');
                    if (contactsListAssigned) {
                        htmx.trigger(contactsListAssigned, 'load');
                    }
                    break;
                case 'message_received':
                    console.log('üí¨ Nova mensagem recebida:', data.message);
                    handleNewMessage(data.message, data.conversation_id);
                    break;
                case 'message_status_update':
                    console.log('üìã Status de mensagem atualizado:', data.message_status);
                    handleMessageStatusUpdate(data.message_status);
                    break;
                default:
                    console.warn('‚ö†Ô∏è Tipo de evento desconhecido:', data.type);
            }
        } catch (error) {
            console.error('‚ùå Erro ao processar mensagem WebSocket:', error);
            console.error('üìÑ Dados brutos:', event.data);
        }
    };
    
    socket.onclose = function(e) {
        console.log('üî¥ WebSocket desconectado. C√≥digo:', e.code, 'Motivo:', e.reason);
        
        // C√≥digos de erro espec√≠ficos
        let errorMessage = '';
        switch(e.code) {
            case 1000:
                errorMessage = 'Conex√£o fechada normalmente';
                break;
            case 1001:
                errorMessage = 'Servidor desconectou';
                break;
            case 1006:
                errorMessage = 'Conex√£o perdida inesperadamente';
                break;
            case 4001:
                errorMessage = 'Usu√°rio n√£o autenticado';
                break;
            case 4003:
                errorMessage = 'Acesso negado - usu√°rio n√£o √© do grupo Comercial';
                break;
            default:
                errorMessage = `Erro desconhecido (${e.code})`;
        }
        
        console.log('üí° Motivo da desconex√£o:', errorMessage);
        
        // Atualiza indicador de status
        const statusIndicator = document.getElementById('connection-status');
        if (statusIndicator) {
            statusIndicator.className = 'status-indicator status-offline';
            statusIndicator.title = `Desconectado: ${errorMessage}`;
        }
        
        // Mostra toast de erro
        console.warn(`üî¥ WebSocket desconectado: ${errorMessage}`);
        
        // Se WebSocket falhar, usa polling como fallback
        startPolling();
        
        // S√≥ tenta reconectar para erros recuper√°veis
        if (e.code !== 4001 && e.code !== 4003) {
            console.log('‚è≥ Tentando reconectar em 10 segundos...');
            setTimeout(connectWebSocket, 10000);
        } else {
            console.log('‚ùå Erro permanente, n√£o tentando reconectar');
        }
    };
    
    socket.onerror = function(error) {
        console.error('‚ùå Erro no WebSocket:', error);
        console.error('‚ùå Erro na conex√£o WebSocket');
    };
}

function handleNewConversation(conversation) {
    // Salva a conversa ID para destacar depois da atualiza√ß√£o
    window.newConversationId = conversation.id;
    
    // Mostra notifica√ß√£o
    showNotification(`Nova conversa de ${conversation.contact_name}`, conversation.message_preview);
    
    // Toca som de notifica√ß√£o (opcional)
    playNotificationSound();
}

function handleNewMessage(message, conversation_id) {
    // Verifica se a mensagem √© da conversa atual
    const currentUrl = new URL(window.location.href);
    const currentConversationId = currentUrl.searchParams.get('conversation');
    
    if (currentConversationId && parseInt(currentConversationId) === parseInt(conversation_id)) {
        // Se estamos visualizando essa conversa, atualiza as mensagens
        console.log('üí¨ Atualizando mensagens da conversa atual');
        
        htmx.ajax('GET', `/comercial/whatsapp/conversation/${conversation_id}/messages/`, {
            target: '#messages-container',
            swap: 'innerHTML'
        });
    } else {
        // Se n√£o estamos na conversa, apenas mostra notifica√ß√£o
        console.log('üí¨ Nova mensagem em conversa n√£o ativa');
        showToast(`Nova mensagem de ${message.contact_name}`, 'info');
    }
    
    // Sempre atualiza a lista de conversas (para mostrar √∫ltima mensagem)
    const contactsList = document.getElementById('contacts-list');
    if (contactsList) {
        htmx.trigger(contactsList, 'load');
    }
    
    // Toca som de notifica√ß√£o
    playNotificationSound();
}

function handleMessageStatusUpdate(statusData) {
    // Verifica se estamos visualizando a conversa da mensagem atualizada
    const currentUrl = new URL(window.location.href);
    const currentConversationId = currentUrl.searchParams.get('conversation');
    
    if (currentConversationId && parseInt(currentConversationId) === parseInt(statusData.conversation_id)) {
        console.log(`üìã Atualizando status da mensagem ${statusData.message_id}: ${statusData.old_status} ‚Üí ${statusData.new_status}`);
        
        // Atualiza apenas o √≠cone de status da mensagem espec√≠fica sem recarregar tudo
        updateMessageStatusIcon(statusData.message_id, statusData.old_status, statusData.new_status);
    } else {
        console.log(`üìã Status atualizado em conversa n√£o ativa (${statusData.conversation_id})`);
    }
}

function updateMessageStatusIcon(messageId, oldStatus, newStatus) {
    // Busca a mensagem espec√≠fica pelo data-message-id
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    
    if (messageElement) {
        // Encontrou a mensagem espec√≠fica, atualiza apenas o √≠cone
        const timeElement = messageElement.querySelector('.message-time');
        const iconElement = timeElement ? timeElement.querySelector('i') : null;
        
        if (iconElement) {
            console.log(`üîÑ Atualizando √≠cone da mensagem ${messageId}: ${oldStatus} ‚Üí ${newStatus}`);
            
            // Remove classes antigas
            iconElement.className = '';
            
            // Adiciona novas classes baseadas no status
            if (newStatus === 'sent') {
                iconElement.className = 'fas fa-check text-muted';
                iconElement.title = 'Enviada';
            } else if (newStatus === 'delivered') {
                iconElement.className = 'fas fa-check-double text-muted';
                iconElement.title = 'Entregue';
            } else if (newStatus === 'read') {
                iconElement.className = 'fas fa-check-double text-primary';
                iconElement.title = 'Lida';
            } else if (newStatus === 'failed') {
                iconElement.className = 'fas fa-exclamation-triangle text-danger';
                iconElement.title = 'Falha no envio';
            }
            
            console.log('‚úÖ √çcone de status atualizado visualmente');
        } else {
            console.warn(`‚ö†Ô∏è √çcone n√£o encontrado para mensagem ${messageId}`);
            // Fallback: recarrega as mensagens
            reloadMessages();
        }
    } else {
        console.warn(`‚ö†Ô∏è Mensagem ${messageId} n√£o encontrada no DOM`);
        // Fallback: recarrega as mensagens
        reloadMessages();
    }
}

function reloadMessages() {
    const currentUrl = new URL(window.location.href);
    const currentConversationId = currentUrl.searchParams.get('conversation');
    
    if (currentConversationId) {
        htmx.ajax('GET', `/comercial/whatsapp/conversation/${currentConversationId}/messages/`, {
            target: '#messages-container',
            swap: 'innerHTML'
        }).then(() => {
            console.log('‚úÖ Mensagens recarregadas');
        });
    }
}

function updatePendingCount(count) {
    console.log('üî¢ Atualizando contador de conversas pendentes:', count);
    
    const badge = document.getElementById('pending-badge');
    if (badge) {
        const oldCount = parseInt(badge.textContent) || 0;
        const newCount = count || 0;
        
        console.log('üìä Contador: ', oldCount, '‚Üí', newCount);
        
        badge.textContent = newCount;
        // Badge vermelho se > 0, cinza se = 0
        badge.style.backgroundColor = newCount > 0 ? '#dc3545' : '#6c757d';
        badge.style.color = 'white';
        
        // Efeito visual se mudou
        if (oldCount !== newCount) {
            badge.style.transform = 'scale(1.2)';
            badge.style.transition = 'transform 0.2s';
            setTimeout(() => {
                badge.style.transform = 'scale(1)';
            }, 200);
        }
        
        console.log('‚úÖ Contador atualizado com sucesso');
    } else {
        console.error('‚ùå Elemento #pending-badge n√£o encontrado');
    }
}

function updateModalIfOpen() {
    // Atualiza modal se estiver aberto
    const modal = document.getElementById('newConversationsModal');
    if (modal && modal.classList.contains('show')) {
        console.log('Modal est√° aberto, atualizando...');
        const pendingContainer = document.getElementById('pending-conversations-container');
        if (pendingContainer) {
            // Usa htmx.ajax em vez de trigger
            htmx.ajax('GET', '/comercial/whatsapp/pending-conversations/', {
                target: '#pending-conversations-container',
                swap: 'innerHTML'
            });
            console.log('Requisi√ß√£o HTMX enviada para modal');
        } else {
            console.log('Container pending-conversations-container n√£o encontrado');
        }
    } else {
        console.log('Modal n√£o est√° aberto');
    }
}

function showNotification(title, message) {
    // Cria notifica√ß√£o visual
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: message,
            icon: '/static/favicon.png',
            tag: 'whatsapp-new-conversation'
        });
    } else {
        // Fallback: mostra alerta visual na p√°gina
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-info alert-dismissible fade show position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 350px;';
        alertDiv.innerHTML = `
            <strong>${title}</strong><br>
            <small>${message}</small>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Remove ap√≥s 5 segundos
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
}

function playNotificationSound() {
    try {
        // Cria um som simples usando Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (e) {
        console.log('Som de notifica√ß√£o n√£o suportado');
    }
}

function highlightNewConversation(conversationId) {
    // Procura pela conversa espec√≠fica usando o data-attribute
    const conversationElement = document.querySelector(`#pending-conversations-container [data-conversation-id="${conversationId}"]`);
    
    if (conversationElement) {
        // Adiciona anima√ß√£o de destaque
        conversationElement.style.border = '2px solid #28a745';
        conversationElement.style.backgroundColor = '#f8fff9';
        conversationElement.style.transform = 'scale(1.02)';
        conversationElement.style.transition = 'all 0.3s ease';
        conversationElement.style.boxShadow = '0 4px 12px rgba(40, 167, 69, 0.3)';
        
        // Remove o destaque ap√≥s 4 segundos
        setTimeout(() => {
            conversationElement.style.border = '';
            conversationElement.style.backgroundColor = '';
            conversationElement.style.transform = '';
            conversationElement.style.boxShadow = '';
            conversationElement.style.transition = '';
        }, 4000);
        
        // Scroll suave at√© a conversa destacada
        conversationElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
        // Fallback: destaca a primeira conversa (mais recente)
        const firstConversation = document.querySelector('#pending-conversations-container .list-group-item:first-child');
        if (firstConversation) {
            firstConversation.style.border = '2px solid #28a745';
            firstConversation.style.backgroundColor = '#f8fff9';
            firstConversation.style.transition = 'all 0.3s ease';
            
            setTimeout(() => {
                firstConversation.style.border = '';
                firstConversation.style.backgroundColor = '';
                firstConversation.style.transition = '';
            }, 3000);
        }
    }
}

// Fallback polling se WebSocket falhar
var pollingInterval = pollingInterval || null;

function startPolling() {
    // Para polling anterior se existir
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
    
    console.log('Iniciando polling como fallback...');
    
    // Polling do contador a cada 5 segundos
    pollingInterval = setInterval(() => {
        fetch('/comercial/whatsapp/pending-count/')
            .then(response => response.json())
            .then(data => updatePendingCount(data.count))
            .catch(console.error);
    }, 5000);
}

function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('Polling interrompido');
    }
}


// Listener HTMX para diversos eventos
if (!window.htmxListenerRegistered) {
    window.htmxListenerRegistered = true;
    
    document.addEventListener('htmx:afterRequest', function(event) {
        // Espec√≠fico para destacar conversas no modal
        if (event.target.id === 'pending-conversations-container' && window.newConversationId) {
            setTimeout(() => {
                highlightNewConversation(window.newConversationId);
                window.newConversationId = null; // Limpa ap√≥s usar
            }, 100);
        }
        
        // Atualiza IDs dos modais quando chat area √© carregada
        if (event.target.id === 'chat-area') {
            updateModalConversationIds();
            initializeChatAreaDropdowns();
        }
    });
    
    // Listener para afterSwap - mais preciso para quando conte√∫do √© inserido
    document.addEventListener('htmx:afterSwap', function(event) {
        // Configura bot√£o de scroll quando chat area √© atualizada
        if (event.target.id === 'chat-area') {
            console.log('üîÑ HTMX afterSwap - Nova conversa carregada');
            setupScrollButton();
        }
        
        // Configura bot√£o quando mensagens s√£o atualizadas
        if (event.target.id === 'messages-container') {
            console.log('üîÑ HTMX afterSwap - Mensagens atualizadas');
            setupScrollButtonForMessages();
        }
    });
}

// Fun√ß√£o para inicializar dropdowns na chat area
function initializeChatAreaDropdowns() {
    // Aguarda um momento para garantir que o DOM est√° pronto
    setTimeout(function() {
        if (typeof bootstrap !== 'undefined') {
            const optionsButton = document.getElementById('optionsDropdownButton');
            if (optionsButton) {
                // Remove qualquer inst√¢ncia existente
                const existingDropdown = bootstrap.Dropdown.getInstance(optionsButton);
                if (existingDropdown) {
                    existingDropdown.dispose();
                }
                // Cria nova inst√¢ncia
                new bootstrap.Dropdown(optionsButton);
            }
        }
    }, 50);
}

// Fun√ß√£o para atualizar IDs de conversa nos modais
function updateModalConversationIds() {
    const chatArea = document.getElementById('chat-area');
    if (chatArea) {
        // Extrai o ID da conversa do formul√°rio de envio de mensagem
        const messageForm = chatArea.querySelector('form[onsubmit*="sendMessage"]');
        if (messageForm) {
            const onsubmit = messageForm.getAttribute('onsubmit');
            const conversationIdMatch = onsubmit.match(/sendMessage\(event, (\d+)\)/);
            if (conversationIdMatch) {
                const conversationId = conversationIdMatch[1];
                
                // Atualiza campo do modal de data de retorno
                const dataRetornoField = document.getElementById('dataRetornoConversationId');
                if (dataRetornoField) {
                    dataRetornoField.value = conversationId;
                }
                
                // Atualiza campo do modal de template
                const sendTemplateField = document.getElementById('sendTemplateConversationId');
                if (sendTemplateField) {
                    sendTemplateField.value = conversationId;
                }
            }
        }
    }
}

// Fun√ß√£o espec√≠fica para atualizar conversation_id do modal de template
function updateTemplateModalConversationId(conversationId) {
    console.log('üîß Atualizando conversation_id do modal de template:', conversationId);
    
    const sendTemplateField = document.getElementById('sendTemplateConversationId');
    if (sendTemplateField) {
        sendTemplateField.value = conversationId;
        console.log('‚úÖ Campo sendTemplateConversationId atualizado:', sendTemplateField.value);
    } else {
        console.log('‚ùå Campo sendTemplateConversationId n√£o encontrado!');
    }
    
    // Tamb√©m atualiza o campo de data de retorno
    const dataRetornoField = document.getElementById('dataRetornoConversationId');
    if (dataRetornoField) {
        dataRetornoField.value = conversationId;
        console.log('‚úÖ Campo dataRetornoConversationId atualizado:', dataRetornoField.value);
    }
}

// Fun√ß√£o para atualizar conversation_id do modal de documento
function updateDocumentModalConversationId(conversationId) {
    console.log('üîß Atualizando conversation_id do modal de documento:', conversationId);
    
    const sendDocumentField = document.getElementById('sendDocumentConversationId');
    if (sendDocumentField) {
        sendDocumentField.value = conversationId;
        console.log('‚úÖ Campo sendDocumentConversationId atualizado:', sendDocumentField.value);
    } else {
        console.log('‚ùå Campo sendDocumentConversationId n√£o encontrado!');
    }
}

// Fun√ß√£o removida - agora usa abordagem mais simples via templates HTMX

// Fun√ß√£o para validar formul√°rio de template antes do envio
function validateTemplateForm(event) {
    const conversationIdField = document.getElementById('sendTemplateConversationId');
    const templateIdField = document.getElementById('templateSelect');
    
    const conversationId = conversationIdField ? conversationIdField.value : '';
    const templateId = templateIdField ? templateIdField.value : '';
    
    console.log('üîç Validando formul√°rio de template:');
    console.log('  - conversation_id:', conversationId);
    console.log('  - template_id:', templateId);
    
    if (!conversationId || conversationId === '') {
        alert('Erro: ID da conversa n√£o encontrado. Por favor, recarregue a p√°gina e tente novamente.');
        event.preventDefault();
        return false;
    }
    
    if (!templateId || templateId === '') {
        alert('Por favor, selecione um template antes de enviar.');
        event.preventDefault();
        return false;
    }
    
    console.log('‚úÖ Formul√°rio v√°lido - enviando...');
    return true;
}

document.addEventListener('DOMContentLoaded', function() {
    // Solicita permiss√£o para notifica√ß√µes
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    // Limpa formul√°rio e preview quando modal de template √© fechado
    const sendTemplateModal = document.getElementById('sendTemplateModal');
    if (sendTemplateModal) {
        sendTemplateModal.addEventListener('hidden.bs.modal', function() {
            console.log('üßπ Limpando modal de template...');
            
            // Limpa o formul√°rio
            const templateForm = document.getElementById('sendTemplateForm');
            if (templateForm) {
                templateForm.reset();
            }
            
            // Limpa o preview
            const templatePreview = document.getElementById('templatePreview');
            if (templatePreview) {
                templatePreview.innerHTML = '';
            }
            
            // Limpa o select de templates (volta ao estado inicial)
            const templateSelect = document.getElementById('templateSelect');
            if (templateSelect) {
                templateSelect.innerHTML = '<option value="">Escolha um template...</option>';
            }
            
            console.log('‚úÖ Modal de template limpo');
        });
    }
    
    // Limpa formul√°rio quando modal de documento √© fechado
    const sendDocumentModal = document.getElementById('sendDocumentModal');
    if (sendDocumentModal) {
        sendDocumentModal.addEventListener('hidden.bs.modal', function() {
            console.log('üßπ Limpando modal de documento...');
            
            // Reseta o container para o formul√°rio inicial
            const documentFormResult = document.getElementById('documentFormResult');
            if (documentFormResult) {
                documentFormResult.innerHTML = `
                    <!-- Formul√°rio inicial -->
                    <form hx-post="{% url 'comercial:send_document' %}" 
                          hx-target="#documentFormResult"
                          hx-swap="innerHTML"
                          hx-encoding="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="conversation_id" value="" id="sendDocumentConversationId">
                        
                        <div class="mb-3">
                            <label for="documentFile" class="form-label">
                                Documento PDF <span class="text-danger">*</span>
                            </label>
                            <input type="file" class="form-control" id="documentFile" name="document" 
                                   accept=".pdf" required>
                            <div class="form-text">Arquivo PDF (m√°x. 16MB)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="documentCaption" class="form-label">Legenda (opcional)</label>
                            <textarea class="form-control" id="documentCaption" name="caption" 
                                      rows="2" placeholder="Adicione uma legenda ao documento..."></textarea>
                        </div>
                        
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-paper-plane me-1"></i>
                                Enviar Documento
                            </button>
                        </div>
                    </form>
                `;
                
                // Re-registra HTMX se necess√°rio
                if (typeof htmx !== 'undefined') {
                    htmx.process(documentFormResult);
                }
            }
            
            console.log('‚úÖ Modal de documento limpo');
        });
    }
    
    // Conecta WebSocket apenas se n√£o estiver conectado
    if (!socket || socket.readyState === WebSocket.CLOSED) {
        connectWebSocket();
    }
    
    // Inicializa dropdowns da chat area na primeira carga
    initializeChatAreaDropdowns();
    
    // Auto-scroll nas mensagens e configura bot√£o de scroll
    const messagesContainer = document.getElementById('messages-container');
    const scrollButton = document.getElementById('scrollToBottom');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Esconde bot√£o inicialmente (conversa inicia no final)
        if (scrollButton) {
            scrollButton.classList.remove('show');
        }
        
        // Adiciona listener para controlar bot√£o de scroll
        messagesContainer.addEventListener('scroll', toggleScrollButton);
    }
    
    // Pr√©-preencher dados do cliente quando modal abrir
    const clientModal = document.getElementById('clientRegistrationModal');
    if (clientModal) {
        clientModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget; // Bot√£o que acionou o modal
            
            if (button) {
                const contactId = button.getAttribute('data-contact-id');
                const contactName = button.getAttribute('data-contact-name');
                const contactPhone = button.getAttribute('data-contact-phone');
                
                // Pr√©-preenche os campos
                document.getElementById('clientName').value = contactName || '';
                
                // Parse do telefone no formato +5511999999999
                if (contactPhone) {
                    const phoneClean = contactPhone.replace('+', '');
                    if (phoneClean.startsWith('55')) {
                        document.getElementById('clientDdi').value = '55';
                        const remainder = phoneClean.substring(2);
                        if (remainder.length >= 10) {
                            // Celular: 11 d√≠gitos no total (DDD + 9 d√≠gitos)
                            document.getElementById('clientDdd').value = remainder.substring(0, 2);
                            document.getElementById('clientTelefone').value = remainder.substring(2);
                        } else if (remainder.length >= 9) {
                            // Fixo: 10 d√≠gitos no total (DDD + 8 d√≠gitos)
                            document.getElementById('clientDdd').value = remainder.substring(0, 2);
                            document.getElementById('clientTelefone').value = remainder.substring(2);
                        }
                    } else {
                        // N√∫mero internacional n√£o brasileiro
                        document.getElementById('clientDdi').value = '';
                        document.getElementById('clientDdd').value = '';
                        document.getElementById('clientTelefone').value = phoneClean;
                    }
                }
                
                // Salva o ID do contato para usar no salvamento
                clientModal.setAttribute('data-current-contact-id', contactId);
            }
        });
    }
});

// Fun√ß√£o para reproduzir √°udio de teste
function playTestAudio() {
    try {
        // Cria um som simples usando Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Som de notifica√ß√£o similar ao WhatsApp
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);
        oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.2);
        oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.3);
        
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
        
        console.log('üéµ √Åudio de teste reproduzido');
    } catch (e) {
        console.log('‚ùå Erro ao reproduzir √°udio:', e);
        alert('N√£o foi poss√≠vel reproduzir o √°udio');
    }
}

// Fun√ß√£o para lidar com erros de v√≠deo
function handleVideoError(videoElement) {
    console.log('‚ùå Erro no v√≠deo:', videoElement);
    try {
        const fallback = videoElement.nextElementSibling;
        if (fallback && fallback.classList.contains('video-error-fallback')) {
            videoElement.style.display = 'none';
            fallback.style.display = 'block';
        }
    } catch (e) {
        console.log('Erro ao mostrar fallback:', e);
    }
}

// Fun√ß√£o para reproduzir v√≠deo de teste
function playTestVideo() {
    try {
        // Simula reprodu√ß√£o de v√≠deo com visual feedback
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        
        // Muda bot√£o para estado "reproduzindo"
        button.innerHTML = '<i class="fas fa-pause me-2"></i>Pausar';
        button.classList.remove('btn-info');
        button.classList.add('btn-warning');
        
        // Simula progresso do v√≠deo
        let progress = 0;
        const progressBar = button.closest('.video-modal-container').querySelector('.bg-info');
        const duration = button.closest('.video-modal-container').querySelector('.text-light');
        
        const interval = setInterval(() => {
            progress += 6.67; // 15 segundos / 15 = 6.67% por "segundo"
            if (progressBar) {
                progressBar.style.width = Math.min(progress, 100) + '%';
            }
            
            // Atualiza tempo
            const currentTime = Math.floor((progress / 100) * 15);
            if (duration) {
                duration.innerHTML = '<i class="fas fa-clock me-1"></i>' + 
                    Math.floor(currentTime / 60) + ':' + 
                    (currentTime % 60).toString().padStart(2, '0') + ' / 0:15';
            }
            
            if (progress >= 100) {
                clearInterval(interval);
                // Restaura estado original
                button.innerHTML = originalContent;
                button.classList.remove('btn-warning');
                button.classList.add('btn-info');
                
                if (progressBar) progressBar.style.width = '80%';
                if (duration) duration.innerHTML = '<i class="fas fa-clock me-1"></i>0:15';
            }
        }, 1000);
        
        console.log('üé¨ V√≠deo de teste reproduzido');
    } catch (e) {
        console.log('‚ùå Erro ao reproduzir v√≠deo:', e);
        alert('N√£o foi poss√≠vel reproduzir o v√≠deo');
    }
}

// Fun√ß√£o para rolar para o final da conversa
function scrollToBottomChat() {
    const messagesContainer = document.getElementById('messages-container');
    const scrollButton = document.getElementById('scrollToBottom');
    
    if (messagesContainer) {
        messagesContainer.scrollTo({
            top: messagesContainer.scrollHeight,
            behavior: 'smooth'
        });
        
        // Esconde o bot√£o imediatamente ao clicar
        if (scrollButton) {
            scrollButton.classList.remove('show');
        }
        
        console.log('üìú Rolando para o final da conversa e escondendo bot√£o');
    }
}

// Fun√ß√£o para controlar visibilidade do bot√£o de scroll
function toggleScrollButton() {
    const messagesContainer = document.getElementById('messages-container');
    const scrollButton = document.getElementById('scrollToBottom');
    
    if (!messagesContainer || !scrollButton) return;
    
    // Verifica se h√° conte√∫do suficiente para scroll
    const hasScrollableContent = messagesContainer.scrollHeight > messagesContainer.clientHeight;
    if (!hasScrollableContent) {
        scrollButton.classList.remove('show');
        return;
    }
    
    // Calcula se est√° pr√≥ximo do final (100px de toler√¢ncia)
    const scrollTop = messagesContainer.scrollTop;
    const scrollHeight = messagesContainer.scrollHeight;
    const clientHeight = messagesContainer.clientHeight;
    const distanceFromBottom = scrollHeight - scrollTop - clientHeight;
    
    // Mostra bot√£o se estiver longe do final (mais de 100px)
    const wasVisible = scrollButton.classList.contains('show');
    if (distanceFromBottom > 100) {
        if (!wasVisible) {
            scrollButton.classList.add('show');
            console.log('üëÜ Usu√°rio subiu na conversa - mostrando bot√£o');
        }
    } else {
        if (wasVisible) {
            scrollButton.classList.remove('show');
            console.log('üëá Usu√°rio chegou ao final - escondendo bot√£o');
        }
    }
}

// Fun√ß√£o para configurar bot√£o de scroll em nova conversa (chamada via HTMX afterSwap)
function setupScrollButton() {
    console.log('üîß Configurando bot√£o de scroll para nova conversa...');
    
    const messagesContainer = document.getElementById('messages-container');
    const scrollButton = document.getElementById('scrollToBottom');
    
    if (!messagesContainer || !scrollButton) {
        console.log('‚ùå Container de mensagens ou bot√£o n√£o encontrado');
        return;
    }
    
    // Remove listener anterior para evitar duplica√ß√£o
    messagesContainer.removeEventListener('scroll', toggleScrollButton);
    
    // Adiciona novo listener
    messagesContainer.addEventListener('scroll', toggleScrollButton);
    
    // O conte√∫do j√° foi carregado pelo HTMX, n√£o precisa de setTimeout
    // Verifica se h√° conte√∫do suficiente para scroll
    const hasScrollableContent = messagesContainer.scrollHeight > messagesContainer.clientHeight;
    
    if (hasScrollableContent) {
        // Se h√° conte√∫do scroll√°vel, vai para o final
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        console.log('üìú Nova conversa com conte√∫do - scrollando para o final');
        
        // Verifica se deve mostrar bot√£o (geralmente n√£o, pois acabou de ir para o final)
        setTimeout(toggleScrollButton, 100);
    } else {
        // Se n√£o h√° conte√∫do suficiente, apenas esconde bot√£o
        scrollButton.classList.remove('show');
        console.log('üì≠ Nova conversa sem conte√∫do suficiente para scroll');
    }
    
    console.log('‚úÖ Bot√£o de scroll configurado para nova conversa');
}

// Fun√ß√£o espec√≠fica para quando mensagens s√£o atualizadas (envio, recebimento, template)
function setupScrollButtonForMessages() {
    console.log('üîß Configurando bot√£o ap√≥s atualiza√ß√£o de mensagens...');
    
    const messagesContainer = document.getElementById('messages-container');
    const scrollButton = document.getElementById('scrollToBottom');
    
    if (!messagesContainer || !scrollButton) return;
    
    // Reconfigura listener (pode ter sido perdido na atualiza√ß√£o)
    messagesContainer.removeEventListener('scroll', toggleScrollButton);
    messagesContainer.addEventListener('scroll', toggleScrollButton);
    
    // Auto-scroll para o final e esconde bot√£o
    messagesContainer.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: 'smooth'
    });
    
    // Esconde bot√£o pois est√° indo para o final
    scrollButton.classList.remove('show');
    
    console.log('‚úÖ Mensagens atualizadas - scrollado para o final e bot√£o escondido');
}

// Fun√ß√£o para salvar cliente
function saveClient() {
    const form = document.getElementById('clientRegistrationForm');
    const formData = new FormData(form);
    const modal = document.getElementById('clientRegistrationModal');
    const contactId = modal.getAttribute('data-current-contact-id');
    
    // Valida√ß√£o b√°sica
    const requiredFields = ['nome', 'tipo_doc', 'doc', 'email', 'ddi', 'ddd', 'telefone'];
    let isValid = true;
    
    for (let field of requiredFields) {
        const input = form.querySelector(`[name="${field}"]`);
        if (!input.value.trim()) {
            input.classList.add('is-invalid');
            isValid = false;
        } else {
            input.classList.remove('is-invalid');
        }
    }
    
    if (!isValid) {
        alert('Por favor, preencha todos os campos obrigat√≥rios.');
        return;
    }
    
    // Desabilita bot√£o durante salvamento
    const saveBtn = document.querySelector('[onclick="saveClient()"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Salvando...';
    
    // Adiciona o ID do contato WhatsApp
    formData.append('whatsapp_contact_id', contactId);
    
    fetch('/comercial/whatsapp/register-client/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fecha modal
            bootstrap.Modal.getInstance(modal).hide();
            
            // Mostra mensagem de sucesso
            alert('Cliente cadastrado com sucesso!');
            
            // Atualiza a p√°gina para mostrar o bot√£o "Ver Cliente"
            window.location.reload();
        } else {
            alert('Erro ao cadastrar cliente: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro na requisi√ß√£o:', error);
        alert('Erro de conex√£o ao cadastrar cliente');
    })
    .finally(() => {
        // Reabilita bot√£o
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    });
}

// Listener para fechar modal via HTMX
document.body.addEventListener('closeModal', function(event) {
    console.log('üìù Fechando modal via HTMX trigger');
    
    // Aguarda 1 segundo para mostrar mensagem de sucesso
    setTimeout(() => {
        const modalElement = document.getElementById('modalNovoContato');
        if (modalElement) {
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.hide();
                
                // Quando o modal fechar, recarrega o container para limpar o form
                modalElement.addEventListener('hidden.bs.modal', function() {
                    const container = document.getElementById('modalNovoContatoContainer');
                    if (container) {
                        htmx.trigger(container, 'load');
                    }
                }, { once: true });
            }
        }
    }, 1000);
});

// Listener para atualizar conversas
document.body.addEventListener('refreshConversations', function(event) {
    console.log('üîÑ Atualizando lista de conversas');
    const contactsList = document.getElementById('contacts-list');
    if (contactsList) {
        htmx.trigger(contactsList, 'load');
    }
    
    // Mostra toast de sucesso
    if (typeof showToast === 'function') {
        showToast('‚úÖ Conversa criada com sucesso!', 'success');
    }
});
</script>
{% endblock %}