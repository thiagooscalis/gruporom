<!-- Resposta de sucesso para envio de template -->
<div class="alert alert-success alert-dismissible fade show" role="alert" id="send-template-alert">
    <i class="fas fa-check-circle me-2"></i>
    Template "{{ template.display_name }}" enviado com sucesso!
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<script>
// Aguarda um momento para garantir que o DOM est√° pronto
setTimeout(() => {
    console.log('üéØ Template de sucesso carregado - resetando modal...');
    
    const modalElement = document.getElementById('sendTemplateModal');
    if (modalElement) {
        // Remove todas as inst√¢ncias existentes
        let modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            console.log('üóëÔ∏è Removendo inst√¢ncia existente do modal...');
            modal.dispose(); // Remove a inst√¢ncia completamente
        }
        
        // Reset completo do modal
        modalElement.classList.remove('show');
        modalElement.style.display = 'none';
        modalElement.setAttribute('aria-hidden', 'true');
        modalElement.removeAttribute('aria-modal');
        modalElement.removeAttribute('role');
        
        // Remove backdrop se existir
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
            console.log('üóëÔ∏è Backdrop removido');
        }
        
        // Remove classe modal-open do body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }
    
    // Limpa formul√°rio e preview
    const form = document.getElementById('sendTemplateForm');
    if (form) {
        form.reset();
        console.log('üìù Formul√°rio resetado');
    }
    
    const preview = document.getElementById('templatePreview');
    if (preview) {
        preview.innerHTML = '';
        console.log('üßπ Preview limpo');
    }
    
    // Limpa o select de templates
    const templateSelect = document.getElementById('templateSelect');
    if (templateSelect) {
        templateSelect.innerHTML = '<option value="">Escolha um template...</option>';
        console.log('üìã Select de templates resetado');
    }
    
    console.log('‚úÖ Modal completamente resetado via template de sucesso');
}, 200);

// Remove o alert ap√≥s 5 segundos
setTimeout(() => {
    const alert = document.getElementById('send-template-alert');
    if (alert) {
        alert.remove();
    }
}, 5000);

// Atualiza as mensagens da conversa via HTMX
const messagesContainer = document.getElementById('messages-container');
if (messagesContainer) {
    // Atualiza mensagens para mostrar o template enviado
    htmx.ajax('GET', '/comercial/whatsapp/conversation/{{ conversation.id }}/messages/', {
        target: '#messages-container',
        swap: 'innerHTML'
    }).then(() => {
        // Scroll para o final ap√≥s atualizar mensagens
        setTimeout(() => {
            const container = document.getElementById('messages-container');
            if (container) {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }, 100);
        
        // Atualiza a lista de contatos ap√≥s as mensagens carregarem
        // para garantir que a conversa apare√ßa no topo (√∫ltima atividade)
        const contactsList = document.getElementById('contacts-list');
        if (contactsList) {
            setTimeout(() => {
                const currentConversationId = '{{ conversation.id }}';
                htmx.ajax('GET', '/comercial/whatsapp/my-conversations/?conversation=' + currentConversationId, {
                    target: '#contacts-list',
                    swap: 'innerHTML'
                });
            }, 200); // Pequeno delay adicional para garantir que o banco foi atualizado
        }
    });
}
</script>