<div class="message {{ message.direction }}" data-message-id="{{ message.id }}">
    <div class="message-bubble">
        <!-- DEBUG: is_media={{ message.is_media }} | media_url="{{ message.media_url }}" | media_id="{{ message.media_id }}" -->
        {% if message.is_media %}
            <!-- Renderização de mídias -->
            {% if message.media_url %}
                {% if message.message_type == 'image' %}
                    <div class="media-message image-message">
                        <img src="{{ message.get_signed_media_url }}" 
                             class="media-image" 
                             alt="Imagem enviada"
                             loading="lazy"
                             hx-get="{% url 'comercial:media_modal' %}?url={{ message.get_signed_media_url|urlencode }}&type=image&name={{ message.media_filename|default:'Imagem'|urlencode }}"
                             hx-target="body"
                             hx-swap="beforeend"
                             style="cursor: pointer;">
                        {% if message.content %}
                            <div class="media-caption">{{ message.content }}</div>
                        {% endif %}
                    </div>
                    
                {% elif message.message_type == 'video' %}
                    <div class="media-message video-message">
                        <video controls class="media-video" preload="metadata" muted>
                            <source src="{{ message.get_signed_media_url }}" type="{{ message.media_mimetype|default:'video/mp4' }}">
                            Seu navegador não suporta vídeos.
                        </video>
                        {% if message.content %}
                            <div class="media-caption">{{ message.content }}</div>
                        {% endif %}
                    </div>
                    
                {% elif message.message_type == 'audio' %}
                    <div class="media-message audio-message">
                        <div class="audio-player">
                            <i class="fas fa-microphone me-2"></i>
                            <audio controls class="media-audio">
                                <source src="{{ message.get_signed_media_url }}" type="{{ message.media_mimetype|default:'audio/ogg' }}">
                                Seu navegador não suporta áudio.
                            </audio>
                        </div>
                    </div>
                    
                {% elif message.message_type == 'document' %}
                    <div class="media-message document-message">
                    <div class="document-preview">
                        <div class="document-icon">
                            {% if '.pdf' in message.media_filename|lower %}
                                <i class="fas fa-file-pdf text-danger"></i>
                            {% elif '.doc' in message.media_filename|lower or '.docx' in message.media_filename|lower %}
                                <i class="fas fa-file-word text-primary"></i>
                            {% elif '.xls' in message.media_filename|lower or '.xlsx' in message.media_filename|lower %}
                                <i class="fas fa-file-excel text-success"></i>
                            {% elif '.ppt' in message.media_filename|lower or '.pptx' in message.media_filename|lower %}
                                <i class="fas fa-file-powerpoint text-warning"></i>
                            {% elif '.zip' in message.media_filename|lower or '.rar' in message.media_filename|lower %}
                                <i class="fas fa-file-archive text-secondary"></i>
                            {% elif '.txt' in message.media_filename|lower %}
                                <i class="fas fa-file-alt text-info"></i>
                            {% else %}
                                <i class="fas fa-file text-muted"></i>
                            {% endif %}
                        </div>
                        <div class="document-info">
                            <div class="document-name">{{ message.media_filename|default:"Documento" }}</div>
                            <div class="document-type">{{ message.media_mimetype|default:"application/octet-stream" }}</div>
                        </div>
                        <a href="{{ message.get_signed_media_url }}" 
                           target="_blank" 
                           class="btn btn-outline-primary btn-sm document-download">
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                    {% if message.content %}
                        <div class="media-caption">{{ message.content }}</div>
                    {% endif %}
                </div>
                
                {% elif message.message_type == 'sticker' %}
                    <div class="media-message sticker-message">
                    <img src="{{ message.get_signed_media_url }}" 
                         class="media-sticker" 
                         alt="Figurinha"
                         loading="lazy">
                </div>
                
                {% elif message.message_type == 'location' %}
                    <div class="media-message location-message">
                    <div class="location-preview">
                        <i class="fas fa-map-marker-alt text-danger me-2"></i>
                        <div class="location-text">{{ message.content }}</div>
                    </div>
                </div>
                
                {% else %}
                    <!-- Mídia desconhecida - fallback -->
                    <div class="media-message unknown-message">
                    <i class="fas fa-file-alt me-2"></i>
                    {{ message.get_display_content }}
                </div>
            {% endif %}
            
            {% else %}
                <!-- Mídia não baixada ainda -->
                <div class="media-message pending-media">
                    <div class="alert alert-warning mb-0">
                        {% if message.message_type == 'image' %}
                            <i class="fas fa-image me-2"></i>
                            <strong>Imagem não carregada</strong>
                        {% elif message.message_type == 'video' %}
                            <i class="fas fa-video me-2"></i>
                            <strong>Vídeo não carregado</strong>
                        {% elif message.message_type == 'audio' %}
                            <i class="fas fa-microphone me-2"></i>
                            <strong>Áudio não carregado</strong>
                        {% elif message.message_type == 'document' %}
                            <i class="fas fa-file me-2"></i>
                            <strong>Documento não carregado</strong>
                        {% else %}
                            <i class="fas fa-paperclip me-2"></i>
                            <strong>Mídia não carregada</strong>
                        {% endif %}
                        <br>
                        <small class="text-muted">
                            {% if message.media_id %}
                                ID: {{ message.media_id }}<br>
                            {% endif %}
                            {% if message.content %}
                                {{ message.content }}
                            {% endif %}
                        </small>
                        <br>
                        <small class="text-danger">
                            A mídia não foi baixada do WhatsApp. 
                            Verifique as credenciais da API.
                        </small>
                    </div>
                </div>
            {% endif %}
            
        {% else %}
            <!-- Mensagem de texto normal -->
            <div class="text-message">{{ message.content|linebreaks }}</div>
        {% endif %}
        
        <!-- Timestamp e status -->
        <div class="message-time">
            {% load core_tags %}
            {{ message.timestamp|smart_datetime }}
            {% if message.direction == 'outbound' %}
                {% if message.status == 'sent' %}
                    <i class="fas fa-check text-muted" title="Enviada"></i>
                {% elif message.status == 'delivered' %}
                    <i class="fas fa-check-double text-muted" title="Entregue"></i>
                {% elif message.status == 'read' %}
                    <i class="fas fa-check-double text-primary" title="Lida"></i>
                {% elif message.status == 'failed' or message.status == 'sending' %}
                    {% if message.status == 'failed' %}
                        <i class="fas fa-exclamation-triangle text-danger" title="Falha no envio"></i>
                    {% else %}
                        <i class="fas fa-clock text-warning" title="Enviando..."></i>
                    {% endif %}
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>