<div class="message {{ message.direction }}" data-message-id="{{ message.id }}">
    <div class="message-bubble">
        {% if message.is_media and message.media_url %}
            <!-- Renderização de mídias -->
            {% if message.message_type == 'image' %}
                <div class="media-message image-message">
                    <img src="{{ message.media_url }}" 
                         class="media-image" 
                         alt="Imagem enviada"
                         loading="lazy"
                         hx-get="{% url 'comercial:media_modal' %}?url={{ message.media_url|urlencode }}&type=image&name={{ message.media_filename|default:'Imagem'|urlencode }}"
                         hx-target="body"
                         hx-swap="beforeend"
                         style="cursor: pointer;">
                    {% if message.content %}
                        <div class="media-caption">{{ message.content }}</div>
                    {% endif %}
                </div>
                
            {% elif message.message_type == 'video' %}
                <div class="media-message video-message">
                    <video controls class="media-video" preload="metadata">
                        <source src="{{ message.media_url }}" type="{{ message.media_mimetype|default:'video/mp4' }}">
                        Seu navegador não suporta vídeos.
                    </video>
                    {% if message.content %}
                        <div class="media-caption">{{ message.content }}</div>
                    {% endif %}
                </div>
                
            {% elif message.message_type == 'audio' %}
                <div class="media-message audio-message">
                    <div class="audio-player">
                        <i class="fas fa-microphone me-2"></i>
                        <audio controls class="media-audio">
                            <source src="{{ message.media_url }}" type="{{ message.media_mimetype|default:'audio/ogg' }}">
                            Seu navegador não suporta áudio.
                        </audio>
                    </div>
                </div>
                
            {% elif message.message_type == 'document' %}
                <div class="media-message document-message">
                    <div class="document-preview">
                        <div class="document-icon">
                            {% if '.pdf' in message.media_filename|lower %}
                                <i class="fas fa-file-pdf text-danger"></i>
                            {% elif '.doc' in message.media_filename|lower or '.docx' in message.media_filename|lower %}
                                <i class="fas fa-file-word text-primary"></i>
                            {% elif '.xls' in message.media_filename|lower or '.xlsx' in message.media_filename|lower %}
                                <i class="fas fa-file-excel text-success"></i>
                            {% elif '.ppt' in message.media_filename|lower or '.pptx' in message.media_filename|lower %}
                                <i class="fas fa-file-powerpoint text-warning"></i>
                            {% elif '.zip' in message.media_filename|lower or '.rar' in message.media_filename|lower %}
                                <i class="fas fa-file-archive text-secondary"></i>
                            {% elif '.txt' in message.media_filename|lower %}
                                <i class="fas fa-file-alt text-info"></i>
                            {% else %}
                                <i class="fas fa-file text-muted"></i>
                            {% endif %}
                        </div>
                        <div class="document-info">
                            <div class="document-name">{{ message.media_filename|default:"Documento" }}</div>
                            <div class="document-type">{{ message.media_mimetype|default:"application/octet-stream" }}</div>
                        </div>
                        <a href="{{ message.media_url }}" 
                           target="_blank" 
                           class="btn btn-outline-primary btn-sm document-download">
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                    {% if message.content %}
                        <div class="media-caption">{{ message.content }}</div>
                    {% endif %}
                </div>
                
            {% elif message.message_type == 'sticker' %}
                <div class="media-message sticker-message">
                    <img src="{{ message.media_url }}" 
                         class="media-sticker" 
                         alt="Figurinha"
                         loading="lazy">
                </div>
                
            {% elif message.message_type == 'location' %}
                <div class="media-message location-message">
                    <div class="location-preview">
                        <i class="fas fa-map-marker-alt text-danger me-2"></i>
                        <div class="location-text">{{ message.content }}</div>
                    </div>
                </div>
                
            {% else %}
                <!-- Mídia desconhecida - fallback -->
                <div class="media-message unknown-message">
                    <i class="fas fa-file-alt me-2"></i>
                    {{ message.get_display_content }}
                </div>
            {% endif %}
        {% else %}
            <!-- Mensagem de texto normal -->
            <div class="text-message">{{ message.content|linebreaks }}</div>
        {% endif %}
        
        <!-- Timestamp e status -->
        <div class="message-time">
            {{ message.timestamp|date:"H:i" }}
            {% if message.direction == 'outbound' %}
                {% if message.status == 'sent' %}
                    <i class="fas fa-check text-muted" title="Enviada"></i>
                {% elif message.status == 'delivered' %}
                    <i class="fas fa-check-double text-muted" title="Entregue"></i>
                {% elif message.status == 'read' %}
                    <i class="fas fa-check-double text-primary" title="Lida"></i>
                {% elif message.status == 'failed' or message.status == 'sending' %}
                    {% if message.status == 'failed' %}
                        <i class="fas fa-exclamation-triangle text-danger" title="Falha no envio"></i>
                    {% else %}
                        <i class="fas fa-clock text-warning" title="Enviando..."></i>
                    {% endif %}
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>